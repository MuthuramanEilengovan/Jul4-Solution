<html>
<head>
    <title>Reservation &amp; Customer Search</title>

    <script src="../WebResources/ClientGlobalContext.js.aspx" type="text/javascript"></script>
    <link href="../WebResources/whb_jquery-ui.css" rel="stylesheet" type="text/css">
    <script src="../WebResources/whb_jquery-1.12.4" type="text/javascript"></script>
    <script src="../WebResources/whb_jquery-ui.js" type="text/javascript"></script>
    <script src="../WebResources/whb_CommonErrorHandling.js" type="text/javascript"></script>

    <style type="text/css">
        input[type="text"] {
            width: 180px;
            height: 20px;
            border-top-color: #c6c6c6;
            border-top-width: 1px;
            border-top-style: solid;
            border-bottom-color: #c6c6c6;
            border-bottom-width: 1px;
            border-bottom-style: solid;
            border-left-color: #c6c6c6;
            border-left-width: 1px;
            border-left-style: solid;
            border-right-color: #c6c6c6;
            border-right-width: 1px;
            border-right-style: solid;
            font-size: 14px;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            font-style: normal;
            color: #000000;
        }

        h1 {
            text-align: center;
        }

        h3 {
            font-family: 'Segoe UI', Arial;
            padding-left: 10px;
            font-size: 24px;
            font-weight: lighter;
            color: black;
        }
        /*//ui-id-1*/

        h2 {
            font-family: 'Segoe UI', Arial;
            font-size: 27px;
            font-weight: lighter;
            background-color: white;
            color: black;
            padding-left: 10px;
        }

        .emptydiv {
            height: 10px;
            width: 100%;
        }

        .btnbutton1 {
            height: 24px;
            font-family: Segoe UI, Tahoma, Arial;
            border: 1px solid #C6C6C6;
            background-image: none;
            margin-top: 10px;
            width: auto;
            min-width: 80px;
            white-space: nowrap;
            line-height: 20px;
            cursor: pointer;
            background-color: white;
            padding: 0 5px 0 5px;
            text-align: center;
            font-size: 11px;
        }

            .btnbutton1:hover {
                color: black;
                background-color: #B1D6F0;
            }

        .btnbutton {
            overflow: visible;
            min-width: 84px;
            width: auto;
            white-space: nowrap;
            line-height: 16px;
            height: 20px;
            width: 84px;
            text-align: center;
            cursor: pointer;
            border-width: 1px;
            border-style: solid;
            background-repeat: repeat-x;
            padding-left: 5px;
            padding-right: 5px;
            font-size: 11px;
            border-color: rgb(189, 195, 199);
        }

            .btnbutton:hover {
                border-color: #336699;
                background-image: url(../../_imgs/theme/Outlook15White/ButtonSelectedGradient.png?ver=357168737);
            }

        .crm-Form-HeaderPosition {
            background-color: rgba(224,224,224,1) !important;
        }

        body {
            left: 3px;
            font-size: 14px;
            font-family: 'Segoe UI', Tahoma, Arial;
            margin-top: 0px;
        }

        #cssTable td {
            text-align: center;
            vertical-align: middle;
        }

        * {
            margin: 0;
            padding: 0;
        }

        .contentdiv {
            font-family: inherit;
            width: 100%;
            min-height: 400px;
        }

        .searchdiv {
            width: 100%;
            font-family: inherit;
        }

        .tableDiv {
            width: 100%;
            font-family: inherit;
        }

        .searchtable {
            width: 100%;
            font-family: inherit;
        }

        .ms-crm-InlineEditLabelText {
            color: #828181 !important;
            font-size: 14px;
            font-family: Segoe\000020UI,Tahoma,Arial;
        }

        .searchtable tr td {
            padding: 2px 0 2px 10px;
            width: auto;
        }

        a {
            color: #1160B7;
            font-weight: normal;
            text-decoration: none;
            display: inline-block;
        }

            a:hover {
                /*color: #0000FF;*/
                text-decoration: underline;
            }

        #prevspan {
            height: 24px;
            font-family: Segoe UI, Tahoma, Arial;
            border: 1px solid #C6C6C6;
            background-image: none;
            margin-top: 10px;
            width: 80px;
            min-width: 80px;
            white-space: nowrap;
            line-height: 24px;
            cursor: pointer;
            background-color: white;
            padding: 0 5px 0 5px;
            text-align: center;
            font-size: 11px;
            position: absolute;
            left: 40px;
        }

            #prevspan:hover {
                cursor: pointer;
                color: black;
                background-color: #B1D6F0;
            }

        #nextspan {
            height: 24px;
            font-family: Segoe UI, Tahoma, Arial;
            border: 1px solid #C6C6C6;
            background-image: none;
            margin-top: 10px;
            width: 80px;
            min-width: 80px;
            white-space: nowrap;
            line-height: 24px;
            cursor: pointer;
            background-color: white;
            padding: 0 5px 0 5px;
            text-align: center;
            font-size: 11px;
            position: absolute;
            left: 85%;
        }

            #nextspan:hover {
                cursor: pointer;
                color: black;
                background-color: #B1D6F0;
            }

        #pagenumberid {
            position: absolute;
            left: 40%;
            font-family: Segoe UI, Tahoma, Arial;
            font-size: 12px;
            font-weight: bold;
            background-image: none;
            margin-top: 10px;
            line-height: 24px;
            background-color: white;
            height: 24px;
        }

        .setwidth {
            width: 110px;
        }

        .setwidth1 {
            width: 180px;
        }

        .addresswidth {
            width: 220px;
        }

        .formHeader {
            font-family: Segoe\000020UI\000020Semibold,Tahoma,sans\00002Dserif;
            font-size: 18px;
            color: #505050;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: top;
            background-color: rgba(224,224,224,1) !important;
            HEIGHT: 37px;
            PADDING-TOP: 9px;
        }

        .tableHeader {
            width: 100%;
            height: 21px;
            table-layout: fixed;
            border-top-width: 1px;
            border-top-style: solid;
            border-bottom-width: 1px;
            border-bottom-style: solid;
            word-wrap: normal;
            border-top-color: #D6D6D6;
            border-bottom-color: #D6D6D6;
            border-color: grey;
            background-color: rgba(0,0,0,0.04) !important;
            background-image: none;
            font-family: Segoe\000020UI,Tahoma,Arial;
            font-size: 11px;
            font-family: Segoe\000020UI\000020Semibold,Tahoma,sans\00002Dserif;
            font-size: 13px;
            color: #505050 !important;
            table-layout: fixed;
            background-color: #FFFFFF;
        }

        .tableTr {
            display: table-row;
            vertical-align: inherit;
            border-color: inherit;
        }

        .tableData {
            overflow: hidden;
            text-overflow: ellipsis;
            padding-top: 0px;
            padding-bottom: 0px;
            height: 36px;
            font-size: 13px;
        }

        table.blueTable {
            border: 1px solid #1C6EA4;
            background-color: #EEEEEE;
            width: 98%;
            text-align: left;
            border-collapse: collapse;
            margin-left: 10px;
        }

            table.blueTable td, table.blueTable th {
                border: 1px solid #AAAAAA;
                padding: 3px 2px;
            }

            table.blueTable tbody td {
                font-size: 11px;
            }

            table.blueTable tr:nth-child(even) {
                background: #D0E4F5;
            }

            table.blueTable thead {
                background: #1C6EA4;
                background: -moz-linear-gradient(top, #5592bb 0%, #327cad 66%, #1C6EA4 100%);
                background: -webkit-linear-gradient(top, #5592bb 0%, #327cad 66%, #1C6EA4 100%);
                background: linear-gradient(to bottom, #5592bb 0%, #327cad 66%, #1C6EA4 100%);
                border-bottom: 2px solid #444444;
            }

                table.blueTable thead th {
                    font-size: 13px;
                    color: #FFFFFF;
                    border-left: 2px solid #D0E4F5;
                }

                    table.blueTable thead th:first-child {
                        border-left: none;
                    }

            table.blueTable tfoot {
                font-size: 11px;
                color: #FFFFFF;
                background: #D0E4F5;
                background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
                background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
                background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
                border-top: 2px solid #444444;
            }

                table.blueTable tfoot td {
                    font-size: 11px;
                }

                table.blueTable tfoot .links {
                    text-align: right;
                }

                    table.blueTable tfoot .links a {
                        display: inline-block;
                        background: #1C6EA4;
                        color: #FFFFFF;
                        padding: 2px 8px;
                        border-radius: 5px;
                    }

        #txtresvId {
            text-transform: uppercase;
        }
    </style>

    <script type="text/javascript">
        // Global variable declaraiton



        var availableProperties = new Array();
        var availablePropertyCodes = new Array();

        // For configuration data
        var APIPassword = "";
        var APIUserName = "";
        var GuestHistoryQuery = "";
        var GuestHistorySearch = "";
        var HistoryRecordDetailQuery = "";
        var ReservationSearch = "";
        var feedBackSearch = "";
        var WSDLService = "";
        var MSCRMCallerID = "";

        // for search fields
        var GlobalsearchReservationNumber = "";
        var GlobalsearchHotelName = "";
        var GlobalsearchArrDate = "";
        var GlobalsearchSurName = "";
        var GlobalsearchEmail = "";
        var GlobalsearchTelephone = "";
        var GlobalsearchPostCode = "";

        // Storing reservation Id
        var GlobalReservationId = "";

        //check booker and stayer are same
        var GlobalBookerAndStayerAreSame = false;

        // Store booker id
        var GlobalBookerId = "";

        // store stayer id
        var GlobalStayerId = "";

        // store feedback data for guest
        var GlobalFeedBackData = "";

        // store property id
        var GlobalPropertyId = "";

        // store arrival date and departure date
        var GlobalArrivalDate = "";
        var GlobalDepartureDate = "";

        // store room number for stayer
        var GlobalRoomNumber = "";

        // for store payments
        var paymentsObject = [];

        // store global guest history id
        var GlobalGuestHistoryId = "";

        // STORE GLOBAL RESERVAITN NUMBER
        var GlobalReservationNumber = "";


        // setting contact info
        var GlobalAddress = "";
        var GlobalPostalCode = "";
        var GlobalphoneNumber = "";
        var GlobalEmailAddressTab = "";

        $(document).ready(function () {
            SetLoadingImage();

            $("#txtDateOfArrival").datepicker({
                dateFormat: "dd/mm/yy"
            });

            GetConfiguratoinValues();
            queryHotelNames();
            $("#txthousename").autocomplete({
                source: availableProperties,
                autoFocus: true,
                sortResults: true
            });
        });

        // To show loading image
        function SetLoadingImage() {
            var image = "<input id='image' type='image' width='70' height='70' alt='Loading...' src='" + Xrm.Page.context.getClientUrl() + "//WebResources/whb_LoadingImage'/>";
            $('#loading').html(image);
        }

        // Get All Property names
        function queryHotelNames() {
            try {
                var req = new XMLHttpRequest();
                req.open("GET", Xrm.Page.context.getClientUrl() + "/api/data/v9.0/whb_properties?$select=whb_name,whb_propertycode&$orderby=whb_name asc", false);
                req.setRequestHeader("OData-MaxVersion", "4.0");
                req.setRequestHeader("OData-Version", "4.0");
                req.setRequestHeader("Accept", "application/json");
                req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                req.setRequestHeader("Prefer", "odata.include-annotations=\"OData.Community.Display.V1.FormattedValue\"");
                //req.setRequestHeader("Prefer", "odata.maxpagesize=20");
                //req.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                req.onreadystatechange = function () {
                    if (this.readyState === 4) {
                        req.onreadystatechange = null;
                        if (this.status === 200) {
                            var results = JSON.parse(this.response);
                            for (var i = 0; i < results.value.length; i++) {
                                availableProperties[i] = results.value[i]["whb_name"];
                                availablePropertyCodes[i] = results.value[i]["whb_propertycode"];
                            }
                        } else {
                            alert("Not able to get properties. Please contact CRM administrator");
                        }
                    }
                };
                req.send();

            } catch (e) {
                ErrorHandling("DPA Search", "DPA Search", "queryHotelNames", e);
            }
        }

        // Getting configuration Values
        // Related to BORT
        function GetConfiguratoinValues() {
            try {
                $.ajax({
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    datatype: "json",
                    url: Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_customizationses?$select=whb_description,whb_name&$filter=whb_name eq 'APIPassword' or  whb_name eq 'APIUserName' or  whb_name eq 'GuestHistoryQuery' or  whb_name eq 'GuestHistorySearch' or  whb_name eq 'HistoryRecordDetailQuery' or  whb_name eq 'ReservationSearch' or  whb_name eq 'WSDLService' or  whb_name eq 'FeedBackSearch' or  whb_name eq 'ServiceAccountForBART'",
                    beforeSend: function (XMLHttpRequest) {
                        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                        XMLHttpRequest.setRequestHeader("Accept", "application/json");
                        XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                    },
                    async: false,
                    success: function (data, textStatus, xhr) {
                        var results = data;
                        for (var i = 0; i < results.value.length; i++) {
                            var configDescription = results.value[i]["whb_description"];
                            var configName = results.value[i]["whb_name"];

                            if (configName == 'APIPassword') {
                                APIPassword = configDescription;
                            }

                            if (configName == 'APIUserName') {
                                APIUserName = configDescription;
                            }

                            if (configName == 'GuestHistoryQuery') {
                                GuestHistoryQuery = configDescription;
                            }

                            if (configName == 'GuestHistorySearch') {
                                GuestHistorySearch = configDescription;
                            }

                            if (configName == 'HistoryRecordDetailQuery') {
                                HistoryRecordDetailQuery = configDescription;
                            }

                            if (configName == 'ReservationSearch') {
                                ReservationSearch = configDescription;
                            }

                            if (configName == 'WSDLService') {
                                WSDLService = configDescription;
                            }

                            if (configName == 'FeedBackSearch') {
                                feedBackSearch = configDescription;
                            }

                            if (configName == 'ServiceAccountForBART') {
                                MSCRMCallerID = configDescription;
                            }
                        }
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        ErrorHandling("DPA Search", "DPA Search", "GetConfiguratoinValues", xhr);
                    }
                });

            } catch (e) {
                ErrorHandling("DPA Search", "DPA Search", "GetConfiguratoinValues", e);

            }
        }

        // Check URL contains any parameters
        // If we click on the dpa search button in Case entity
        // Passing case id in the URL
        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) { return pair[1]; }
            }
            return false;
        }

        function resetValues() {
            try {
                $('#txtresvId').val('');
                $('#txtBookref').val('');
                $('#txtemail').val('');
                $('#txtsurname').val('');
                $('#txtpostal').val('');
                $('#txtphone').val('');
                $('#txtsurname').val('');
                $('#txthousename').val('');
                $('#txtDateOfArrival').val('');
                $('#txtDaysonEitherSide').val('');
            }
            catch (e) {
                ErrorHandling("DPA Search", "DPA Search", "resetValues", e);
            }
        }

        // Validation of email address
        function checkEmail(email) {
            var filter = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;

            if (!filter.test(email)) {
                alert('Please provide a valid email address');
                email.focus;
                return false;
            }
            return true;
        }

        function formatDateUKFormat(date) {



            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [day, month, year].join('/');
        }

        function formatDateForAPIServices(date) {


            var newDate = date.split('/');
            return newDate[2] + "-" + newDate[1] + "-" + newDate[0];
        }

        function formatDate(date) {



            var newDate = date.split('/');
            return newDate[1] + "/" + newDate[0] + "/" + newDate[2];
        }

        function SearchReservationAndContact() {
            try {
                GetConfiguratoinValues();

                $('#CreateCase').prop('disabled', true);
                GlobalsearchReservationNumber = "";
                GlobalsearchHotelName = "";
                GlobalsearchArrDate = "";
                GlobalsearchSurName = "";
                GlobalsearchEmail = "";
                GlobalsearchTelephone = "";
                GlobalsearchPostCode = "";
                var arrayOfObjects = [];
                $(".tableDiv").empty();

                $('#txtSearchedFields').val("");
                var SearchedFields = "";
                var contactOrReservationFlag = false;

                var surname = $('#txtsurname').val().trim();
                var reservationId = $('#txtresvId').val().trim();
                var bookingRef = $('#txtBookref').val().trim();
                var hotelname = $('#txthousename').val().trim();
                var DOA = $('#txtDateOfArrival').val().trim();
                var DOES = $('#txtDaysonEitherSide').val().trim();
                var emailAdd = $('#txtemail').val().trim();
                var postalCode = $('#txtpostal').val().trim();
                var telPhone = $('#txtphone').val().trim();

                GlobalsearchReservationNumber = reservationId;
                GlobalsearchHotelName = hotelname;
                GlobalsearchArrDate = DOA;
                GlobalsearchSurName = surname;
                GlobalsearchEmail = emailAdd;
                GlobalsearchTelephone = telPhone;
                GlobalsearchPostCode = postalCode;

                // if all the search parameters are empty
                if (surname == "" && reservationId == "" && bookingRef == "" && emailAdd == "" && postalCode == "" && telPhone == "" && hotelname == "" && DOA == "") {
                    alert("Cannot search, Please enter atleast one search parameter");
                    return false;
                }

                if (surname != "" && (reservationId == "" && bookingRef == "" && emailAdd == "" && postalCode == "" && telPhone == "" && hotelname == "" && DOA == "")) {
                    alert("Surname should always be paired with another search criteria");
                    return false;
                }

                if (hotelname != "" && reservationId == "" && bookingRef == "") {
                    if (DOA == "" && surname == "") {
                        alert("For Searching Hotel Name Individually, The Date Of Arrival is Mandatory");
                        return false;
                    }
                }

                if (DOA != "" && reservationId == "" && bookingRef == "") {
                    if (hotelname == "" && surname == "") {
                        alert("For Searching Date Of Arrival Individually, The Hotel Name is Mandatory");
                        return false;
                    }
                }

                if (hotelname != "" && hotelname != null && hotelname != undefined && hotelname != '') {
                    for (var a = 0; a < availableProperties.length; a++) {
                        if (availableProperties[a] == hotelname) {
                            hotelname = availablePropertyCodes[a];
                            break;
                        }
                    }
                }

                if (emailAdd != "") {
                    if (checkEmail(emailAdd)) {
                        if (surname == "" && postalCode == "") {
                            alert("Email Address is always  paired with either Postcode or Surname.");
                            return false;
                        }
                    }
                    else
                        return false;
                }

                if (telPhone != "") {
                    if (surname == "" && postalCode == "") {
                        alert("Telephone is always  paired with either Postcode or Surname.");
                        return false;
                    }
                }

                if (DOES != "") {
                    if ($.isNumeric(DOES)) {
                        if (DOES >= 0 && DOES <= 30) {
                            //
                        }
                        else {
                            alert("The value in Days Either Side field must be in the range 0 to 30.");
                            return false;
                        }
                    }
                    else {
                        alert("Please enter the numeric values in Days Either Side fild.");
                        return false;
                    }
                }

                if (DOA != "") {
                    DOA = formatDateForAPIServices(DOA);
                }

                if (reservationId != "")
                    reservationId = reservationId.trim().toUpperCase();
                if (bookingRef != "")
                    bookingRef = bookingRef.trim().toUpperCase();
                if (postalCode != "")
                    postalCode = postalCode.trim().toUpperCase();
                if (hotelname != "")
                    hotelname = hotelname.trim().toUpperCase();

                // Call the BART API for reservation
                if (reservationId != "" || bookingRef != "" || hotelname != "" || DOA != "")
                    arrayOfObjects = GetResearvationDetails(surname, reservationId, bookingRef, hotelname, DOA, DOES);
                    // Call BART API for guest search
                else if (surname != "" || emailAdd != "" || postalCode != "" || telPhone != "")
                    arrayOfObjects = GetContactDetails(surname, emailAdd, postalCode, telPhone);

                // Show the result in a table format on the form
                BindTable(arrayOfObjects);
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "SearchReservationAndContact", err);
            }
        }

        function EnableCheckDPAButton() {
            $('#CreateCase').prop('disabled', false);
        }

        // Show the response in a table format
        function BindTable(arrayOfObjects) {
            try {
                var tr = "";
                tr = '<table class="blueTable" id="ResultTable" style="font-family: Segoe\000020UI\000020Semibold,Tahoma,sans\00002Dserif;">';
                tr += "<thead>";
                tr += "<tr>";
                tr += "<th>Action</th>";
                tr += "<th>Reservation Number</th>";
                tr += "<th>Guest Name</th>";
                tr += "<th>Booker Name</th>";
                tr += "<th>Address</th>";
                tr += "<th>Postal Code</th>";
                tr += "<th>Email</th>";
                tr += "<th>Registered</th>";
                tr += "<th>Contact Phone numbers</th>";
                tr += "<th>Hotel Name</th>";
                tr += "<th>Arrival Date</th>";
                tr += "</tr>";
                tr += "</thead>";
                tr += "<tbody>";
                for (let i = 0; i < arrayOfObjects.length; i++) {
                    var obj = arrayOfObjects[i];

                    tr += "<tr >";

                    //if (obj.whb_ReservationNumber != undefined && obj.whb_ReservationNumber != "" && obj.whb_ReservationNumber != null && ((obj.guestHistoryNumber != undefined && obj.guestHistoryNumber != null && obj.guestHistoryNumber != "") || (obj.guestRoomId != undefined && obj.guestRoomId != null && obj.guestRoomId != "")))
                    tr += '<td ><input name="selectedRow" onclick="EnableCheckDPAButton()" type="radio" id="chkAction" class="use-address"></td >'
                    //else
                    //tr += '<td></td>';

                    if (obj.whb_ReservationNumber != undefined && obj.whb_ReservationNumber != null)
                        tr += '<td>' + obj.whb_ReservationNumber + "</td>";
                    else
                        tr += '<td></td>';

                    if (obj._whb_guestdetails_value_formatted != undefined && obj._whb_guestdetails_value_formatted != null)
                        tr += '<td>' + obj._whb_guestdetails_value_formatted + "</td>";
                    else
                        tr += '<td></td>';

                    if (obj.bookerInformation != undefined && obj.bookerInformation != null)
                        tr += '<td>' + obj.bookerInformation + "</td>";
                    else
                        tr += '<td></td>';

                    if (obj.whb_addressline1 != undefined && obj.whb_addressline1 != null)
                        tr += '<td>' + obj.whb_addressline1 + "</td>";
                    else
                        tr += '<td></td>';

                    if (obj.whb_postcode != undefined && obj.whb_postcode != null)
                        tr += '<td>' + obj.whb_postcode + "</td>";
                    else
                        tr += '<td></td>';

                    if (obj.email != undefined && obj.email != null)
                        tr += '<td>' + obj.email + "</td>";
                    else
                        tr += '<td></td>';

                    if (obj.registered != undefined && obj.registered != null)
                        tr += '<td>' + obj.registered + "</td>";
                    else
                        tr += '<td></td>';

                    if (obj.whb_telephone != undefined && obj.whb_telephone != null)
                        tr += '<td>' + obj.whb_telephone + "</td>";
                    else
                        tr += '<td></td>';

                    if (obj.hotelName != undefined && obj.hotelName != null)
                        tr += '<td>' + obj.hotelName + "</td>";
                    else
                        tr += '<td></td>';

                    if (obj.whb_arrivaldate != undefined && obj.whb_arrivaldate != null && obj.whb_arrivaldate != "") {
                        var arrDateFormatted = formatDateUKFormat(obj.whb_arrivaldate);
                        tr += '<td>' + arrDateFormatted + "</td>";
                    }
                    else
                        tr += '<td></td>';

                    if (obj.depDate != undefined && obj.depDate != null && obj.depDate != "") {
                        var deptDateFormatted = formatDateUKFormat(obj.depDate);
                        tr += "<td style='display:none'>" + deptDateFormatted + "</td>";
                    }
                    else
                        tr += "<td style='display:none'></td>";

                    if (obj.hotelCode != undefined && obj.hotelCode != null)
                        tr += "<td style='display:none'>" + obj.hotelCode + "</td>";
                    else
                        tr += "<td style='display:none'></td>";

                    if (obj.guestHistoryNumber != undefined && obj.guestHistoryNumber != null)
                        tr += "<td style='display:none'>" + obj.guestHistoryNumber + "</td>";
                    else
                        tr += "<td style='display:none'></td>";

                    if (obj.source != undefined && obj.source != null)
                        tr += "<td style='display:none'>" + obj.source + "</td>";
                    else
                        tr += "<td style='display:none'></td>";

                    if (obj.BorkerOrStayer != undefined && obj.BorkerOrStayer != null)
                        tr += "<td style='display:none'>" + obj.BorkerOrStayer + "</td>";
                    else
                        tr += "<td style='display:none'></td>";

                    if (obj.BusinessOrPrivateAddress != undefined && obj.BusinessOrPrivateAddress != null)
                        tr += "<td style='display:none'>" + obj.BusinessOrPrivateAddress + "</td>";
                    else
                        tr += "<td style='display:none'></td>";

                    if (obj.guestRoomId != undefined && obj.guestRoomId != null)
                        tr += "<td style='display:none'>" + obj.guestRoomId + "</td>";
                    else
                        tr += "<td style='display:none'></td>";

                    if (obj.thirdPartyReference != undefined && obj.thirdPartyReference != null)
                        tr += "<td style='display:none'>" + obj.thirdPartyReference + "</td>";
                    else
                        tr += "<td style='display:none'></td>";

                    if (obj.historyRecordNumber != undefined && obj.historyRecordNumber != null)
                        tr += "<td style='display:none'>" + obj.historyRecordNumber + "</td>";
                    else
                        tr += "<td style='display:none'></td>";

                    tr += "</tr>";
                }

                $(".tableDiv").empty();
                if (arrayOfObjects.length == 0) {
                    tr += '<tr><td colspan="10">No records exists for the current search. </td></tr>';
                }

                tr += "</tbody>";
                tr += " </table>";

                document.getElementsByClassName("tableDiv")[0].innerHTML = tr;
                $('#loading').hide();
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "BindTable", err);
            }
        }

        // Guest Details BART API Search
        function GetContactDetails(surname, emailAddress, postalCode, telephone) {
            var arrayOfObjects = [];
            try {
                var requestData = '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:cas="http://caseman.oracle.com"><soapenv:Header><Login><username>' + APIUserName + '</username><password>' + APIPassword + '</password></Login></soapenv:Header><soapenv:Body>';
                requestData += '<cas:guestHistorySearch><cas:request>';
                requestData += '<cas:surname>' + surname + '</cas:surname>';
                requestData += '<cas:firstName></cas:firstName>';
                requestData += '<cas:postcode>' + postalCode + '</cas:postcode>';
                requestData += '<cas:addressLine1></cas:addressLine1>';
                requestData += '<cas:telephone>' + telephone + '</cas:telephone>';
                requestData += '<cas:companyName></cas:companyName>';
                requestData += '<cas:guestHistoryNumber></cas:guestHistoryNumber>';
                requestData += '<cas:email>' + emailAddress + '</cas:email>';
                requestData += '</cas:request></cas:guestHistorySearch>';
                requestData += '</soapenv:Body></soapenv:Envelope>';

                var getContactDetailsResponse = CallRequest(WSDLService, GuestHistorySearch, requestData);
                arrayOfObjects = ReadGuestHistoryResponseXML(getContactDetailsResponse);
                return arrayOfObjects;
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "GetContactDetails", err);
            }
        }

        // Read response of BART
        function ReadGuestHistoryResponseXML(response) {
            var arrayOfObjects = [];
            try {
                var xmlDoc = response;

                $(xmlDoc).find('guestHistorySearchResult').each(function () {
                    $(this).find('guests').each(function () {
                        $(this).find('guest').each(function () {
                            var historyNumber = $(this).find('historyNumber').text();
                            //alert("history : "+historyNumber);
                            var guestName = $(this).find('title').text() + ' ' + $(this).find('firstName').text() + ' ' + $(this).find('lastName').text();
                            var check = 0;

                            var registerd = $(this).find('registered').text();
                            if (registerd == "false") {
                                registerd = "No";
                            }
                            else if (registerd == "true") {
                                registerd = "Yes";
                            }
                            else
                                registerd = "";

                            var private_PrivateAddress = "";
                            var private_whb_addressline1 = "";
                            var private_whb_postcode = "";
                            var private_email = "";
                            var private_whb_telephone = "";

                            var business_BusinessAddress = "";
                            var business_whb_addressline1 = "";
                            var business_whb_postcode = "";
                            var business_email = "";
                            var business_whb_telephone = "";

                            var pastStayExists = ""
                            var futureStayExists = "";

                            if (historyNumber != "") {
                                var xmlGuestHistoryresponse = GetGuestHisotryQueriyDetails(historyNumber);

                                //alert("calling query2");
                                $(xmlGuestHistoryresponse).find('guestDetails').each(function () {
                                    //alert("calling query3");
                                    $(this).find('homeAddress').each(function () {
                                        private_PrivateAddress = 'P';
                                        private_whb_addressline1 = $(this).find('addressLine1').text();
                                        private_whb_postcode = $(this).find('postCode').text();
                                        private_email = $(this).find('emailId').text();
                                        var mobileNumberOrTelephone1 = "";
                                        var mobileNumberOrTelephone2 = "";
                                        $(this).find('telephoneNumbers').each(function () {
                                            $(this).find('Telephone').each(function () {
                                                if ($(this).find('numberType').text() == 'MOBILE') {
                                                    mobileNumberOrTelephone1 = $(this).find('telephoneNumber').text();
                                                }
                                                if ($(this).find('numberType').text() == 'TELEPHONE')
                                                    mobileNumberOrTelephone2 = $(this).find('telephoneNumber').text();
                                            });
                                        });

                                        if (mobileNumberOrTelephone1 != "" && mobileNumberOrTelephone2 != "")
                                            private_whb_telephone = mobileNumberOrTelephone1 + " / " + mobileNumberOrTelephone2;
                                        else if (mobileNumberOrTelephone1 != "")
                                            private_whb_telephone = mobileNumberOrTelephone1;
                                        else if (mobileNumberOrTelephone2 != "")
                                            private_whb_telephone = mobileNumberOrTelephone2;

                                    });

                                    $(this).find('businessAddress').each(function () {
                                        business_BusinessAddress = 'B';
                                        business_whb_addressline1 = $(this).find('addressLine1').text();
                                        business_whb_postcode = $(this).find('postCode').text();
                                        business_email = $(this).find('emailId').text();
                                        var mobileNumberOrTelephone1 = "";
                                        var mobileNumberOrTelephone2 = "";

                                        $(this).find('telephoneNumbers').each(function () {
                                            $(this).find('Telephone').each(function () {
                                                if ($(this).find('numberType').text() == 'MOBILE') {
                                                    mobileNumberOrTelephone1 = $(this).find('telephoneNumber').text();
                                                }
                                                if ($(this).find('numberType').text() == 'TELEPHONE')
                                                    mobileNumberOrTelephone2 = $(this).find('telephoneNumber').text();
                                            });
                                        });

                                        if (mobileNumberOrTelephone1 != "" && mobileNumberOrTelephone2 != "")
                                            business_whb_telephone = mobileNumberOrTelephone1 + " / " + mobileNumberOrTelephone2;
                                        else if (mobileNumberOrTelephone1 != "")
                                            business_whb_telephone = mobileNumberOrTelephone1;
                                        else if (mobileNumberOrTelephone2 != "")
                                            business_whb_telephone = mobileNumberOrTelephone2;
                                    });
                                });
                                //alert("calling query 4");
                                $(xmlGuestHistoryresponse).find('pastStays').each(function () {
                                    $(this).find('Stay').each(function () {
                                        pastStayExists = "1";
                                        var resNumber = "";
                                        resNumber = $(this).find('reservationNumber').text();
                                        if (resNumber.length < 5)
                                            resNumber = "";
                                        var resThirdPartyBookingReferenceNumber = "";
                                        var roomNumberId = "";
                                        var bookerInformation = "";
                                        var historyRecordNumber = $(this).find('historyRecordNumber').text();

                                        if (resNumber != "") {
                                            var reservationResponse = GetResearvationDetailsWithReservationNumber("", resNumber, "", "", "", "");
                                            $(reservationResponse).find('ReservationSearchResult').each(function () {
                                                resThirdPartyBookingReferenceNumber = $(this).find('thirdPartyReference').text();
                                                $(this).find('replyContact').each(function () {
                                                    var repayContactGuestHistoryNumber = $(this).find('guestHistoryNumber').text();
                                                    bookerInformation = $(this).find('firstName').text() + " " + $(this).find('lastName').text();
                                                });
                                                $(this).find('roomsbooked').each(function () {
                                                    $(this).find('RoomDetails').each(function () {
                                                        var roomId = $(this).find('roomId').text();
                                                        $(this).find('stayer').each(function () {
                                                            if ($(this).find('guestHistoryNumber').text() == historyNumber) {
                                                                roomNumberId = roomId;
                                                            }
                                                        });
                                                    });
                                                });
                                            });
                                        }

                                        var resHotelCode = "";
                                        resHotelCode = $(this).find('hotelCode').text();

                                        var hotelName = "";
                                        if (resHotelCode != "" && resHotelCode != undefined && resHotelCode != null) {
                                            if ($.inArray(resHotelCode, availablePropertyCodes) != -1) {
                                                var indexOfHotelCode = $.inArray(resHotelCode, availablePropertyCodes);
                                                hotelName = availableProperties[indexOfHotelCode];
                                            }
                                        }

                                        var arrivalDate = $(this).find('arrivalDate').text();
                                        var departureDate = $(this).find('departureDate').text();

                                        var repayStayerObjectPrivateAddress = new Object()
                                        var repayStayerObjectBusinessAddress = new Object()

                                        if (private_whb_addressline1 != "" || private_whb_postcode != "" || private_email != "" || private_whb_telephone != "") {
                                            repayStayerObjectPrivateAddress.whb_ReservationNumber = resNumber;
                                            repayStayerObjectPrivateAddress.hotelName = hotelName;
                                            repayStayerObjectPrivateAddress.whb_arrivaldate = arrivalDate;
                                            repayStayerObjectPrivateAddress._whb_guestdetails_value_formatted = guestName;
                                            repayStayerObjectPrivateAddress.source = 'C';
                                            repayStayerObjectPrivateAddress.BorkerOrStayer = 'S';
                                            repayStayerObjectPrivateAddress.BusinessOrPrivateAddress = 'P';
                                            repayStayerObjectPrivateAddress.guestHistoryNumber = historyNumber;
                                            repayStayerObjectPrivateAddress.depDate = departureDate;
                                            repayStayerObjectPrivateAddress.hotelCode = resHotelCode;
                                            repayStayerObjectPrivateAddress.whb_addressline1 = private_whb_addressline1;
                                            repayStayerObjectPrivateAddress.whb_postcode = private_whb_postcode;
                                            repayStayerObjectPrivateAddress.email = private_email;
                                            repayStayerObjectPrivateAddress.registered = registerd;
                                            repayStayerObjectPrivateAddress.whb_telephone = private_whb_telephone;
                                            repayStayerObjectPrivateAddress.guestRoomId = roomNumberId;
                                            repayStayerObjectPrivateAddress.thirdPartyReference = resThirdPartyBookingReferenceNumber;
                                            repayStayerObjectPrivateAddress.bookerInformation = bookerInformation;
                                            repayStayerObjectPrivateAddress.historyRecordNumber = historyRecordNumber;
                                            arrayOfObjects.push(repayStayerObjectPrivateAddress);
                                        }
                                        if (business_whb_addressline1 != "" || business_whb_postcode != "" || business_email != "" || business_whb_telephone != "") {
                                            repayStayerObjectBusinessAddress.whb_ReservationNumber = resNumber;
                                            repayStayerObjectBusinessAddress.hotelName = hotelName;
                                            repayStayerObjectBusinessAddress.whb_arrivaldate = arrivalDate;
                                            repayStayerObjectBusinessAddress._whb_guestdetails_value_formatted = guestName;
                                            repayStayerObjectBusinessAddress.source = 'C';
                                            repayStayerObjectBusinessAddress.BorkerOrStayer = 'S';
                                            repayStayerObjectBusinessAddress.BusinessOrPrivateAddress = 'B';
                                            repayStayerObjectBusinessAddress.guestHistoryNumber = historyNumber;
                                            repayStayerObjectBusinessAddress.depDate = departureDate;
                                            repayStayerObjectBusinessAddress.hotelCode = resHotelCode;
                                            repayStayerObjectBusinessAddress.whb_addressline1 = business_whb_addressline1;
                                            repayStayerObjectBusinessAddress.whb_postcode = business_whb_postcode;
                                            repayStayerObjectBusinessAddress.email = business_email;
                                            repayStayerObjectBusinessAddress.registered = registerd;
                                            repayStayerObjectBusinessAddress.whb_telephone = business_whb_telephone;
                                            repayStayerObjectBusinessAddress.guestRoomId = roomNumberId;
                                            repayStayerObjectBusinessAddress.thirdPartyReference = resThirdPartyBookingReferenceNumber;
                                            repayStayerObjectBusinessAddress.bookerInformation = bookerInformation;
                                            repayStayerObjectBusinessAddress.historyRecordNumber = historyRecordNumber;
                                            arrayOfObjects.push(repayStayerObjectBusinessAddress);
                                        }
                                    });
                                });

                                $(xmlGuestHistoryresponse).find('futureStays').each(function () {
                                    $(this).find('Stay').each(function () {
                                        futureStayExists = "1";
                                        var resNumber = "";
                                        resNumber = $(this).find('reservationNumber').text();
                                        if (resNumber.length < 5)
                                            resNumber = "";

                                        var resThirdPartyBookingReferenceNumber = "";
                                        var roomNumberId = "";
                                        var bookerInformation = "";
                                        var historyRecordNumber = $(this).find('historyRecordNumber').text();

                                        if (resNumber != "") {
                                            var reservationResponse = GetResearvationDetailsWithReservationNumber("", resNumber, "", "", "", "");
                                            $(reservationResponse).find('ReservationSearchResult').each(function () {
                                                resThirdPartyBookingReferenceNumber = $(this).find('thirdPartyReference').text();
                                                $(this).find('replyContact').each(function () {
                                                    var repayContactGuestHistoryNumber = $(this).find('guestHistoryNumber').text();
                                                    bookerInformation = $(this).find('firstName').text() + " " + $(this).find('lastName').text();
                                                });
                                                $(this).find('roomsbooked').each(function () {
                                                    $(this).find('RoomDetails').each(function () {
                                                        var roomId = $(this).find('roomId').text();
                                                        $(this).find('stayer').each(function () {
                                                            if ($(this).find('guestHistoryNumber').text() == historyNumber) {
                                                                roomNumberId = roomId;
                                                            }
                                                        });
                                                    });
                                                });
                                            });
                                        }

                                        var resHotelCode = "";
                                        resHotelCode = $(this).find('hotelCode').text();
                                        PropertyName = "";
                                        var getHotelName = "";
                                        if (resHotelCode != "" && resHotelCode != undefined && resHotelCode != null) {
                                            if ($.inArray(resHotelCode, availablePropertyCodes) != -1) {
                                                var indexOfHotelCode = $.inArray(resHotelCode, availablePropertyCodes);
                                                getHotelName = availableProperties[indexOfHotelCode];
                                            }
                                        }

                                        var arrivalDate = $(this).find('arrivalDate').text();
                                        var departureDate = $(this).find('departureDate').text();
                                        if (private_whb_addressline1 != "" || private_whb_postcode != "" || private_email != "" || private_whb_telephone != "") {
                                            var repayStayerObject = new Object()
                                            repayStayerObject.whb_ReservationNumber = resNumber;
                                            repayStayerObject.hotelName = getHotelName;
                                            repayStayerObject.whb_arrivaldate = arrivalDate;
                                            repayStayerObject._whb_guestdetails_value_formatted = guestName;
                                            repayStayerObject.source = 'C';
                                            repayStayerObject.BorkerOrStayer = 'S';
                                            repayStayerObject.BusinessOrPrivateAddress = 'P';
                                            repayStayerObject.guestHistoryNumber = historyNumber;
                                            repayStayerObject.depDate = departureDate;
                                            repayStayerObject.hotelCode = resHotelCode;
                                            repayStayerObject.whb_addressline1 = private_whb_addressline1;
                                            repayStayerObject.whb_postcode = private_whb_postcode;
                                            repayStayerObject.email = private_email;
                                            repayStayerObject.registered = registerd;
                                            repayStayerObject.whb_telephone = private_whb_telephone;
                                            repayStayerObject.guestRoomId = roomNumberId;
                                            repayStayerObject.thirdPartyReference = resThirdPartyBookingReferenceNumber;
                                            repayStayerObject.bookerInformation = bookerInformation;
                                            repayStayerObject.historyRecordNumber = historyRecordNumber;
                                            arrayOfObjects.push(repayStayerObject);
                                        }
                                        if (business_whb_addressline1 != "" || business_whb_postcode != "" || business_email != "" || business_whb_telephone != "") {
                                            var repayStayerObject = new Object()
                                            repayStayerObject.whb_ReservationNumber = resNumber;
                                            repayStayerObject.hotelName = getHotelName;
                                            repayStayerObject.whb_arrivaldate = arrivalDate;
                                            repayStayerObject._whb_guestdetails_value_formatted = guestName;
                                            repayStayerObject.source = 'C';
                                            repayStayerObject.BorkerOrStayer = 'S';
                                            repayStayerObject.BusinessOrPrivateAddress = 'B';
                                            repayStayerObject.guestHistoryNumber = historyNumber;
                                            repayStayerObject.depDate = departureDate;
                                            repayStayerObject.hotelCode = resHotelCode;
                                            repayStayerObject.whb_addressline1 = business_whb_addressline1;
                                            repayStayerObject.whb_postcode = business_whb_postcode;
                                            repayStayerObject.email = business_email;
                                            repayStayerObject.registered = registerd;
                                            repayStayerObject.whb_telephone = business_whb_telephone;
                                            repayStayerObject.guestRoomId = roomNumberId;
                                            repayStayerObject.thirdPartyReference = resThirdPartyBookingReferenceNumber;
                                            repayStayerObject.bookerInformation = bookerInformation;
                                            repayStayerObject.historyRecordNumber = historyRecordNumber;
                                            arrayOfObjects.push(repayStayerObject);
                                        }
                                    });
                                });
                            }

                            if (pastStayExists == "" && futureStayExists == "" && historyNumber != "") {

                                if (private_whb_addressline1 != "" || private_whb_postcode != "" || private_email != "" || private_whb_telephone != "") {
                                    var repayStayerObject = new Object()
                                    repayStayerObject.whb_ReservationNumber = "";
                                    repayStayerObject.hotelName = "";
                                    repayStayerObject.whb_arrivaldate = "";
                                    repayStayerObject._whb_guestdetails_value_formatted = guestName;
                                    repayStayerObject.source = 'C';
                                    repayStayerObject.BorkerOrStayer = 'S';
                                    repayStayerObject.BusinessOrPrivateAddress = 'P';
                                    repayStayerObject.guestHistoryNumber = historyNumber;
                                    repayStayerObject.depDate = "";
                                    repayStayerObject.hotelCode = "";
                                    repayStayerObject.whb_addressline1 = private_whb_addressline1;
                                    repayStayerObject.whb_postcode = private_whb_postcode;
                                    repayStayerObject.email = "";
                                    repayStayerObject.registered = registerd;
                                    repayStayerObject.whb_telephone = private_whb_telephone;
                                    repayStayerObject.guestRoomId = "";
                                    repayStayerObject.thirdPartyReference = "";
                                    repayStayerObject.bookerInformation = "";
                                    arrayOfObjects.push(repayStayerObject);
                                }
                                if (business_whb_addressline1 != "" || business_whb_postcode != "" || business_email != "" || business_whb_telephone != "") {
                                    var repayStayerObject = new Object()
                                    repayStayerObject.whb_ReservationNumber = "";
                                    repayStayerObject.hotelName = "";
                                    repayStayerObject.whb_arrivaldate = "";
                                    repayStayerObject._whb_guestdetails_value_formatted = guestName;
                                    repayStayerObject.source = 'C';
                                    repayStayerObject.BorkerOrStayer = 'S';
                                    repayStayerObject.BusinessOrPrivateAddress = 'B';
                                    repayStayerObject.guestHistoryNumber = historyNumber;
                                    repayStayerObject.depDate = "";
                                    repayStayerObject.hotelCode = "";
                                    repayStayerObject.whb_addressline1 = business_whb_addressline1;
                                    repayStayerObject.whb_postcode = business_whb_postcode;
                                    repayStayerObject.email = business_email;
                                    repayStayerObject.registered = "";
                                    repayStayerObject.whb_telephone = business_whb_telephone;
                                    repayStayerObject.guestRoomId = "";
                                    repayStayerObject.thirdPartyReference = "";
                                    repayStayerObject.bookerInformation = "";
                                    arrayOfObjects.push(repayStayerObject);
                                }
                            }
                            else if (pastStayExists == "" && futureStayExists == "" && historyNumber == "") {
                                var repayStayerObject = new Object()
                                repayStayerObject.whb_ReservationNumber = "";
                                repayStayerObject.hotelName = "";
                                repayStayerObject.whb_arrivaldate = "";
                                repayStayerObject._whb_guestdetails_value_formatted = guestName;
                                repayStayerObject.source = 'C';
                                repayStayerObject.BorkerOrStayer = 'S';
                                repayStayerObject.BusinessOrPrivateAddress = 'B';
                                repayStayerObject.guestHistoryNumber = "";
                                repayStayerObject.depDate = "";
                                repayStayerObject.hotelCode = "";

                                $(this).find('private').each(function () {
                                    private_PrivateAddress = 'P';
                                    private_whb_addressline1 = $(this).find('address').text();
                                    private_whb_postcode = $(this).find('postcode').text();
                                    private_email = $(this).find('email').text();
                                });
                                repayStayerObject.whb_addressline1 = private_whb_addressline1;
                                repayStayerObject.whb_postcode = private_whb_postcode;
                                repayStayerObject.email = private_email;
                                repayStayerObject.registered = "";
                                repayStayerObject.whb_telephone = "";
                                repayStayerObject.guestRoomId = "";
                                repayStayerObject.thirdPartyReference = "";
                                repayStayerObject.bookerInformation = "";
                                arrayOfObjects.push(repayStayerObject);
                            }
                        });
                    });
                });
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "ReadGuestHistoryResponseXML", err);
            }

            return arrayOfObjects;
        }

        // Reservation BART API Search
        function GetResearvationDetails(surname, reservationNumber, bookingRef, hotelname, DOA, DOES) {

            var arrayOfObjects = [];

            try {
                var requestData = '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:cas="http://caseman.oracle.com"><soapenv:Header><Login><username>' + APIUserName + '</username><password>' + APIPassword + '</password></Login></soapenv:Header><soapenv:Body><cas:reservationSearch><cas:request>';
                if (reservationNumber != "")
                    requestData += '<cas:reservationNumber>' + reservationNumber.trim().toUpperCase() + '</cas:reservationNumber>';
                requestData += '<cas:guestLastName>' + surname + '</cas:guestLastName>';
                requestData += '<cas:hotelCode>' + hotelname + '</cas:hotelCode>';
                requestData += '<cas:arrivalDate>' + DOA + '</cas:arrivalDate>';
                requestData += '<cas:daysEitherSide>' + DOES + '</cas:daysEitherSide>';
                if (bookingRef != "")
                    requestData += '<cas:thirdPartyReference>' + bookingRef.trim().toUpperCase() + '</cas:thirdPartyReference>';
                requestData += '</cas:request></cas:reservationSearch></soapenv:Body></soapenv:Envelope>';

                var reservationResponse = CallRequest(WSDLService, ReservationSearch, requestData);
                arrayOfObjects = ReadReservatinResponseXML(reservationResponse);
                return arrayOfObjects;
            }


            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "GetResearvationDetails", err);
            }
        }

        // Reservation BART API Search
        function GetResearvationDetailsWithReservationNumber(surname, reservationNumber, bookingRef, hotelname, DOA, DOES) {

            var arrayOfObjects = [];

            try {
                var requestData = '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:cas="http://caseman.oracle.com"><soapenv:Header><Login><username>' + APIUserName + '</username><password>' + APIPassword + '</password></Login></soapenv:Header><soapenv:Body><cas:reservationSearch><cas:request>';
                requestData += '<cas:reservationNumber>' + reservationNumber + '</cas:reservationNumber>';
                requestData += '<cas:guestLastName>' + surname + '</cas:guestLastName>';
                requestData += '<cas:hotelCode>' + hotelname + '</cas:hotelCode>';
                requestData += '<cas:arrivalDate>' + DOA + '</cas:arrivalDate>';
                requestData += '<cas:daysEitherSide>' + DOES + '</cas:daysEitherSide>';
                requestData += '<cas:thirdPartyReference>' + bookingRef + '</cas:thirdPartyReference>';
                requestData += '</cas:request></cas:reservationSearch></soapenv:Body></soapenv:Envelope>';

                var reservationResponse = CallRequest(WSDLService, ReservationSearch, requestData);

                return reservationResponse;
            }
            catch (ex) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "GetResearvationDetailsWithReservationNumber", err);
            }
        }

        // Read reservation response
        function ReadReservatinResponseXML(reservationResponse) {
            try {
                debugger;
                var arrayOfObjects = [];

                $(reservationResponse).find('ReservationSearchResult').each(function () {
                    var resNumberResult = $(this).find('resNumber').text();
                    var resHotelNameResult = $(this).find('hotelName').text();
                    var resArrivalDateResult = $(this).find('arrDate').text();
                    var resDeptDateResult = $(this).find('depDate').text();
                    var resHotelCodeResult = $(this).find('hotelCode').text();
                    var resThirdPartyBookingReferenceNumber = $(this).find('thirdPartyReference').text();
                    var repayContactGuestHistoryNumber = "";
                    var bookerMatched = 0;
                    var bookerInformation = "";
                    var guestRoomId = "";

                    $(this).find('replyContact').each(function () {
                        repayContactGuestHistoryNumber = $(this).find('guestHistoryNumber').text();
                        bookerInformation = $(this).find('firstName').text() + " " + $(this).find('lastName').text();
                    });

                    $(this).find('roomsbooked').each(function () {
                        $(this).find('RoomDetails').each(function () {
                            guestRoomId = $(this).find('roomId').text();
                            $(this).find('stayer').each(function () {
                                var stayerExists = 0;
                                var stayerName = $(this).find('firstName').text() + ' ' + $(this).find('lastName').text();
                                if ($(this).find('guestHistoryNumber').length > 0) {
                                    var xmlGuestHistoryresponse = "";
                                    if ($(this).find('guestHistoryNumber').text() != "")
                                        xmlGuestHistoryresponse = GetGuestHisotryQueriyDetails($(this).find('guestHistoryNumber').text());
                                    var guestHistoryNumber = $(this).find('guestHistoryNumber').text();
                                    if (repayContactGuestHistoryNumber == guestHistoryNumber) {
                                        bookerMatched = 1;
                                    }

                                    $(xmlGuestHistoryresponse).find('guestDetails').each(function () {
                                        $(this).find('homeAddress').each(function () {
                                            var repayStayerObject = new Object()
                                            repayStayerObject.whb_ReservationNumber = resNumberResult;
                                            repayStayerObject.hotelName = resHotelNameResult;
                                            repayStayerObject.whb_arrivaldate = resArrivalDateResult;
                                            repayStayerObject._whb_guestdetails_value_formatted = stayerName;
                                            repayStayerObject.guestRoomId = guestRoomId;
                                            repayStayerObject.thirdPartyReference = resThirdPartyBookingReferenceNumber;
                                            repayStayerObject.source = 'R';
                                            repayStayerObject.BorkerOrStayer = 'S';
                                            repayStayerObject.BusinessOrPrivateAddress = 'P';
                                            repayStayerObject.depDate = resDeptDateResult;
                                            repayStayerObject.guestHistoryNumber = guestHistoryNumber;
                                            repayStayerObject.hotelCode = resHotelCodeResult;
                                            var homeAddressAddressLine1 = "";
                                            homeAddressAddressLine1 = $(this).find('addressLine1').text();
                                            repayStayerObject.whb_addressline1 = homeAddressAddressLine1;
                                            var homeAddressPostCode = "";
                                            homeAddressPostCode = $(this).find('postCode').text();
                                            repayStayerObject.whb_postcode = homeAddressPostCode;
                                            var homeAddressEmail = "";
                                            homeAddressEmail = $(this).find('emailId').text();
                                            repayStayerObject.email = homeAddressEmail;
                                            repayStayerObject.bookerInformation = bookerInformation;
                                            repayStayerObject.registered = '';
                                            var mobileNumberOrTelephone1 = "";
                                            var mobileNumberOrTelephone2 = "";
                                            $(this).find('telephoneNumbers').each(function () {
                                                $(this).find('Telephone').each(function () {

                                                    if ($(this).find('numberType').text() == 'MOBILE') {
                                                        mobileNumberOrTelephone1 = $(this).find('telephoneNumber').text();
                                                    }
                                                    if ($(this).find('numberType').text() == 'TELEPHONE')
                                                        mobileNumberOrTelephone2 = $(this).find('telephoneNumber').text();
                                                });
                                            });

                                            if (mobileNumberOrTelephone1 != "" && mobileNumberOrTelephone2 != "")
                                                repayStayerObject.whb_telephone = mobileNumberOrTelephone1 + " / " + mobileNumberOrTelephone2;
                                            else if (mobileNumberOrTelephone1 != "")
                                                repayStayerObject.whb_telephone = mobileNumberOrTelephone1;
                                            else if (mobileNumberOrTelephone2 != "")
                                                repayStayerObject.whb_telephone = mobileNumberOrTelephone2;

                                            if (homeAddressAddressLine1 != "" || homeAddressPostCode != "" || homeAddressEmail != "" || mobileNumberOrTelephone1 != "" || mobileNumberOrTelephone2 != "") {
                                                arrayOfObjects.push(repayStayerObject);
                                                stayerExists = 1;
                                            }
                                        });


                                        $(this).find('businessAddress').each(function () {
                                            var repayStayerObject = new Object()
                                            repayStayerObject.whb_ReservationNumber = resNumberResult;
                                            repayStayerObject.hotelName = resHotelNameResult;
                                            repayStayerObject.whb_arrivaldate = resArrivalDateResult;
                                            repayStayerObject._whb_guestdetails_value_formatted = stayerName;
                                            repayStayerObject.guestRoomId = guestRoomId;
                                            repayStayerObject.thirdPartyReference = resThirdPartyBookingReferenceNumber;
                                            repayStayerObject.source = 'R';
                                            repayStayerObject.BorkerOrStayer = 'S';
                                            repayStayerObject.BusinessOrPrivateAddress = 'B';
                                            repayStayerObject.guestHistoryNumber = guestHistoryNumber;
                                            repayStayerObject.depDate = resDeptDateResult;
                                            repayStayerObject.hotelCode = resHotelCodeResult;
                                            var BAAddressLine1 = "";
                                            BAAddressLine1 = $(this).find('addressLine1').text();
                                            repayStayerObject.whb_addressline1 = BAAddressLine1;
                                            var BAPostCode = "";
                                            BAPostCode = $(this).find('postCode').text();
                                            repayStayerObject.whb_postcode = BAPostCode;
                                            var BAEmailId = "";
                                            BAEmailId = $(this).find('emailId').text();
                                            repayStayerObject.email = BAEmailId;
                                            repayStayerObject.registered = '';
                                            repayStayerObject.bookerInformation = bookerInformation;
                                            var mobileNumberOrTelephone1 = "";
                                            var mobileNumberOrTelephone2 = "";
                                            $(this).find('telephoneNumbers').each(function () {
                                                $(this).find('Telephone').each(function () {

                                                    if ($(this).find('numberType').text() == 'MOBILE') {
                                                        mobileNumberOrTelephone1 = $(this).find('telephoneNumber').text();
                                                        //repayStayerObject.whb_telephone = $(this).find('telephoneNumber').text();
                                                    }
                                                    if ($(this).find('numberType').text() == 'TELEPHONE')
                                                        mobileNumberOrTelephone2 = $(this).find('telephoneNumber').text();
                                                    //repayStayerObject.whb_telephone = mobileNumberOrTelephone + $(this).find('telephoneNumber').text();
                                                });
                                            });

                                            if (mobileNumberOrTelephone1 != "" && mobileNumberOrTelephone2 != "")
                                                repayStayerObject.whb_telephone = mobileNumberOrTelephone1 + " / " + mobileNumberOrTelephone2;
                                            else if (mobileNumberOrTelephone1 != "")
                                                repayStayerObject.whb_telephone = mobileNumberOrTelephone1;
                                            else if (mobileNumberOrTelephone2 != "")
                                                repayStayerObject.whb_telephone = mobileNumberOrTelephone2;


                                            if (BAAddressLine1 != "" || BAPostCode != "" || BAEmailId != "" || mobileNumberOrTelephone1 != "" || mobileNumberOrTelephone2 != "") {
                                                arrayOfObjects.push(repayStayerObject);
                                                stayerExists = 1;
                                            }
                                        });
                                    });
                                }
                                if (stayerExists == 0) {
                                    var repayStayerObject = new Object()
                                    repayStayerObject.whb_ReservationNumber = resNumberResult;
                                    repayStayerObject.hotelName = resHotelNameResult;
                                    repayStayerObject.whb_arrivaldate = resArrivalDateResult;
                                    repayStayerObject._whb_guestdetails_value_formatted = stayerName;
                                    repayStayerObject.guestRoomId = guestRoomId;
                                    repayStayerObject.thirdPartyReference = resThirdPartyBookingReferenceNumber;
                                    repayStayerObject.source = 'R';
                                    repayStayerObject.BorkerOrStayer = 'S';
                                    repayStayerObject.BusinessOrPrivateAddress = "";
                                    repayStayerObject.depDate = resDeptDateResult;
                                    repayStayerObject.guestHistoryNumber = guestHistoryNumber;
                                    repayStayerObject.hotelCode = resHotelCodeResult;
                                    repayStayerObject.email = "";
                                    repayStayerObject.bookerInformation = bookerInformation;

                                    arrayOfObjects.push(repayStayerObject);
                                }
                            });
                        });
                    });

                    // not using below function
                    // only consider stayer information
                    if (bookerMatched == 0) {
                        //$(this).find('replyContact').each(function () {
                        //    var repayContactObject = new Object()
                        //    repayContactObject.whb_ReservationNumber = resNumberResult;
                        //    var xmlHistoryQueryResponse = GetReservationHisotryQueriyDetails(resNumberResult, "", "");

                        //    $(xmlHistoryQueryResponse).find('booker').each(function () {
                        //        repayContactObject.email = $(this).find('emailAddress').text();
                        //        repayContactObject.registered = '';
                        //        repayContactObject.whb_telephone = $(this).find('telephoneNumber').text();
                        //        repayContactObject.guestHistoryNumber = $(this).find('guestHistoryNumber').text();

                        //        repayContactObject.BorkerOrStayer = 'B';;
                        //        repayContactObject.BusinessOrPrivateAddress = 'B';
                        //        $(this).find('address').each(function () {
                        //            repayContactObject.whb_addressline1 = $(this).find('addressLine1').text();
                        //            repayContactObject.whb_postcode = $(this).find('postCode').text();
                        //        });
                        //    });
                        //    repayContactObject.bookerInformation = bookerInformation;
                        //    repayContactObject.hotelName = resHotelNameResult;
                        //    repayContactObject.whb_arrivaldate = resArrivalDateResult;
                        //    repayContactObject.depDate = resDeptDateResult;
                        //    repayContactObject.hotelCode = resHotelCodeResult;
                        //    repayContactObject.thirdPartyReference = resThirdPartyBookingReferenceNumber;
                        //    repayContactObject._whb_guestdetails_value_formatted = $(this).find('firstName').text() + ' ' + $(this).find('lastName').text();
                        //    repayContactObject.source = 'R';
                        //    arrayOfObjects.push(repayContactObject);
                        //});
                    }
                });
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "ReadReservatinResponseXML", err);
            }

            return arrayOfObjects;
        }

        // Reservation History BART API Search
        function GetReservationHisotryQueriyDetails(reservatinNumber, guestHistoryNumber, roomId) {
            try {
                var requestData = '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:cas="http://caseman.oracle.com"><soapenv:Header><Login><username>' + APIUserName + '</username><password>' + APIPassword + '</password></Login></soapenv:Header><soapenv:Body>';
                requestData += '<cas:historyRecordDetailQuery><cas:request>';
                requestData += '<cas:reservationNumber>' + reservatinNumber + '</cas:reservationNumber>';
                if (roomId != "")
                    requestData += '<cas:roomID>' + roomId + '</cas:roomID>';
                // if (guestHistoryNumber != "")
                //requestData += '<cas:historyRecord><cas:guestHistoryNumber>' + guestHistoryNumber + '</cas:guestHistoryNumber></cas:historyRecord>';
                requestData += '</cas:request></cas:historyRecordDetailQuery>';
                requestData += '</soapenv:Body></soapenv:Envelope>';

                var reservationHistoryRecordDetailsQueryResponse = CallRequest(WSDLService, HistoryRecordDetailQuery, requestData);
                return reservationHistoryRecordDetailsQueryResponse;
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "GetReservationHisotryQueriyDetails", err);
            }
        }

        // Reservation History BART API Search
        function GetReservationHisotryQueriyDetailsForWalkin(guestHistoryNumber, historyRecordNumber) {
            try {
                var requestData = '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:cas="http://caseman.oracle.com"><soapenv:Header><Login><username>' + APIUserName + '</username><password>' + APIPassword + '</password></Login></soapenv:Header><soapenv:Body>';
                requestData += '<cas:historyRecordDetailQuery><cas:request>';

                requestData += '<cas:historyRecord><cas:guestHistoryNumber>' + guestHistoryNumber + '</cas:guestHistoryNumber><cas:historyRecordNumber>' + historyRecordNumber + '</cas:historyRecordNumber></cas:historyRecord>';
                requestData += '</cas:request></cas:historyRecordDetailQuery>';
                requestData += '</soapenv:Body></soapenv:Envelope>';

                var reservationHistoryRecordDetailsQueryResponse = CallRequest(WSDLService, HistoryRecordDetailQuery, requestData);
                return reservationHistoryRecordDetailsQueryResponse;
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "GetReservationHisotryQueriyDetails", err);
            }
        }

        // Get guest history details
        function GetGuestHisotryQueriyDetails(guestHistoryNumber) {
            try {
                var requestData = '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:cas="http://caseman.oracle.com"><soapenv:Header><Login><username>' + APIUserName + '</username><password>' + APIPassword + '</password></Login></soapenv:Header><soapenv:Body>';
                requestData += '<cas:guestHistoryQuery><cas:request>';
                requestData += '<cas:guestHistoryNumber>' + guestHistoryNumber + '</cas:guestHistoryNumber>';
                requestData += '</cas:request></cas:guestHistoryQuery>';
                requestData += '</soapenv:Body></soapenv:Envelope>';

                var guestHistoryQueryResponse = CallRequest(WSDLService, GuestHistoryQuery, requestData);
                return guestHistoryQueryResponse;
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "GetGuestHisotryQueriyDetails", err);
            }
        }

        // Call BART API service
        function CallRequest(WSDLService, reservationSOAPAction, requestData) {
            var soapResponseFromBART = "";
            requestData = requestData.replace(/\\/g, '');
            $.ajax({
                url: WSDLService,
                type: "POST",
                async: false,
                contentType: 'text/xml',
                headers: {
                    SOAPAction: reservationSOAPAction
                },
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Access-Control-Allow-origin', '*');
                },
                data: requestData,
                success: function (SOAPResponse, hrs) {
                    soapResponseFromBART = SOAPResponse;
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $('#loading').hide();
                    ErrorHandling("DPA Search", "DPA Search", "CallRequest", jqXHR);
                }
            });
            return soapResponseFromBART;
        }

        function CheckDPA() {
            SetLoadingImage();
            $('#loading').show();
            setTimeout(function () { CheckDPAMainFunctin(); }, 1000);
        }

        // check dpa main function
        function CheckDPAMainFunctin() {
            try {

                var dpaRoomNumber = "";
                var reservatinEntityId = '';
                var reservationNumberRes = "";
                var customerName = "";
                var lastname = "";
                var firstname = "";
                var address = "";
                var postalCode = "";
                var emailAddressTab = "";
                var registered = "";
                var arrivalDate = "";
                var deptDate = "";
                var guestHistory = "";
                var brokerOrStayer = "";
                var businessOrPrivateAddress = "";
                var hotelName = "";
                var hotelCode = "";
                var guestRoomId = "";
                var thirdPartyReference = "";
                var title = "";
                var historyRecordNumber = "";
                var phoneNumber = "";

                $(".tableDiv").find('#ResultTable').find('tr').each(function () {
                    if ($(this).find('#chkAction').length > 0) {
                        if ($(this).find('#chkAction').prop("checked") == true) {
                            var tableData = $(this).children("td").map(function () {
                                return $(this).text();
                            }).get();
                            if (tableData != null) {
                                reservationNumberRes = tableData[1].trim();
                                customerName = tableData[2].trim();

                                if (customerName != null && customerName != "") {
                                    var customerNameSplit = customerName.split(' ');
                                    if (customerNameSplit.length == 2) {
                                        lastname = customerNameSplit[1];
                                        firstname = customerNameSplit[0];
                                    } else if (customerNameSplit.length == 3) {
                                        lastname = customerNameSplit[2];
                                        firstname = customerNameSplit[1];
                                        title = customerNameSplit[0];
                                    }
                                    else
                                        lastname = customerName;
                                }
                                address = tableData[4].trim();
                                postalCode = tableData[5].trim();
                                emailAddressTab = tableData[6].trim();
                                registered = tableData[7].trim();
                                phoneNumber = tableData[8].trim();
                                hotelName = tableData[9].trim();
                                if (tableData[10].trim() !="")
                                    arrivalDate = formatDate(tableData[10].trim());
                                if (tableData[11].trim() !="")
                                    deptDate = formatDate(tableData[11].trim());
                                hotelCode = tableData[12].trim();
                                guestHistory = tableData[13].trim();
                                businessOrPrivateAddress = tableData[16].trim();
                                guestRoomId = tableData[17].trim();
                                thirdPartyReference = tableData[18].trim();
                                historyRecordNumber = tableData[19].trim();
                            }
                            return false;
                        }
                    }
                });

                if (reservationNumberRes != "") {
                    // sometimes hotel code coming in the reservation number (Walk-In)
                    if (reservationNumberRes.length < 5)
                        reservationNumberRes = "";
                }

                if (reservationNumberRes == "" && guestRoomId == "" && guestHistory == "")
                    alert("Reservation Number, Room Id and Guest History number doesn't exists for selected record.");
                else if (reservationNumberRes != "" && guestHistory != "" && guestRoomId == "")
                    alert("Room Id doesn't exists for this selected record.");
                else if (reservationNumberRes == "" && guestRoomId == "" && guestHistory != "")
                    alert("Reservation Number and Room Id doesn't exists for selected record.");
                else if (reservationNumberRes != "" && guestRoomId == "" && guestHistory == "")
                    alert("GuestHistory Number and Room Id doesn't exists for selected record.");

                // get configuration entity values
                GetConfiguratoinValues();



                // Create or update reservation
                if (reservationNumberRes != "" && guestRoomId != "")
                    CreateReservation(reservationNumberRes, guestHistory, guestRoomId, businessOrPrivateAddress, thirdPartyReference);
                else if (reservationNumberRes != "")
                    CreateReservation(reservationNumberRes, guestHistory, "", businessOrPrivateAddress, thirdPartyReference);
                else if (reservationNumberRes == "" && guestHistory != "" && historyRecordNumber != "")
                    CreateReservationForWalkin(reservationNumberRes, guestHistory, "", businessOrPrivateAddress, thirdPartyReference, historyRecordNumber);

                var onlyGuestNameExists = "1";

                // if booker and stayer are same
                if (GlobalBookerAndStayerAreSame == true)
                    GlobalStayerId = GlobalBookerId;
                if (GlobalBookerAndStayerAreSame == false) {
                    //create contact if guest history number present and this guest history number not same as booker guest history number
                    if (guestHistory != "" && GlobalBookerAndStayerAreSame == false && reservationNumberRes != "")
                        GetGuestDetailsofReservation(reservationNumberRes, guestHistory, businessOrPrivateAddress, GlobalReservationId, "");
                    else if (guestHistory == "" && reservationNumberRes != "" && guestRoomId != "")//create contact if there is no guest history number
                        GetGuestDetailsofReservationWithoutGuestHistoryNumber(reservationNumberRes, guestRoomId, GlobalReservationId);
                    else if (guestHistory != "") {
                        onlyGuestNameExists = "2";
                        GetGuestDetailsofReservation("", guestHistory, businessOrPrivateAddress, "", "");
                    }
                    else if (guestHistory == "" && reservationNumberRes != "") {

                        CreateContact(title, "", GlobalReservationId, firstname, lastname, emailAddressTab, phoneNumber, phoneNumber, "", "", "", address, "", "", "", postalCode, "", "", reservationNumberRes, "");
                    }
                    else if (guestHistory == "") {
                        onlyGuestNameExists = "2";
                        CreateContact(title, "", "", firstname, lastname, emailAddressTab, phoneNumber, phoneNumber, "", "", "", address, "", "", "", postalCode, "", "", "", "");
                    }
                }
                // Create guest details records in crm
                if (reservationNumberRes != "" && guestRoomId != "" && GlobalStayerId !="")
                    GuestDetails(reservationNumberRes, guestRoomId, guestHistory);
                else if (reservationNumberRes == "" && guestHistory != "" && GlobalStayerId != "" && historyRecordNumber != "")
                    GuestDetailsForWalkins(reservationNumberRes, guestRoomId, guestHistory, historyRecordNumber)

                var propertyIDforWalkin = "";


                // create dpa if there is no reservation number and room id exists
                if (onlyGuestNameExists == "2") {
                    if (GlobalStayerId != "" && GlobalBookerId == "")
                        GlobalBookerId = GlobalStayerId;
                    if (GlobalAddress == "")
                        GlobalAddress = address;
                    if (GlobalPostalCode == "")
                        GlobalPostalCode = postalCode
                    if (GlobalphoneNumber == "")
                        GlobalphoneNumber = phoneNumber;
                    if (GlobalEmailAddressTab == "")
                        GlobalEmailAddressTab = emailAddressTab;

                    if (hotelCode != "") {
                        propertyIDforWalkin = GetPropertyId(hotelCode);
                    } else if (propertyIDforWalkin == "" && hotelName != "") {
                        propertyIDforWalkin = GetPropertyIdFromPropertyName(hotelName);
                    }
                }

                var DPAEntity = {};
                DPAEntity.whb_addressline1 = GlobalAddress;
                DPAEntity.whb_postcode = GlobalPostalCode;
                DPAEntity.whb_telephone = GlobalphoneNumber;
                DPAEntity.whb_emailaddress = GlobalEmailAddressTab;
                if (GlobalArrivalDate != "")
                    DPAEntity.whb_arrivaldate = new Date(GlobalArrivalDate);
                if (GlobalDepartureDate != "")
                    DPAEntity.whb_departuredate = new Date(GlobalDepartureDate);

                DPAEntity.whb_name = " ";

                // if only guest naem exists
                if (onlyGuestNameExists == "2") {
                    if (propertyIDforWalkin != "" && GlobalPropertyId == "") {
                        DPAEntity["whb_HotelName@odata.bind"] = "/whb_properties(" + propertyIDforWalkin + ")";
                    }
                    if (arrivalDate != "" && GlobalArrivalDate == "") {
                        DPAEntity.whb_arrivaldate = new Date(arrivalDate).toISOString();
                    }
                }

                if (GlobalPropertyId != "")
                    DPAEntity["whb_HotelName@odata.bind"] = "/whb_properties(" + GlobalPropertyId + ")";

                if (GlobalReservationId != "")
                    DPAEntity["whb_Reservation@odata.bind"] = "/whb_reservations(" + GlobalReservationId + ")";

                if (GlobalStayerId != "") {
                    DPAEntity["whb_Contact@odata.bind"] = "/contacts(" + GlobalStayerId + ")";
                }

                if (GlobalBookerId != "") {
                    DPAEntity["whb_bookername@odata.bind"] = "/contacts(" + GlobalBookerId + ")";
                }

                var countOfSearchedValues = 0;
                var searchedValues = "";
                if (GlobalsearchReservationNumber.trim() != '') {
                    DPAEntity.whb_reservationckb = true;
                    countOfSearchedValues = countOfSearchedValues + 1;
                    searchedValues = searchedValues + GlobalsearchReservationNumber.trim() + ",";
                }
                if (GlobalsearchHotelName.trim() != '') {
                    DPAEntity.whb_hotelnameflag = true;
                    countOfSearchedValues = countOfSearchedValues + 1;
                    searchedValues = searchedValues + GlobalsearchHotelName.trim() + ",";
                }
                if (GlobalsearchArrDate.trim() != '') {
                    DPAEntity.whb_arrivaldateflag = true;
                    countOfSearchedValues = countOfSearchedValues + 1;
                    searchedValues = searchedValues + GlobalsearchArrDate.trim() + ",";
                }
                if (GlobalsearchSurName.trim() != '') {
                    DPAEntity.whb_contactflag = true;
                    countOfSearchedValues = countOfSearchedValues + 1;
                    searchedValues = searchedValues + customerName.trim() + ",";
                }
                if (GlobalsearchEmail.trim() != '') {
                    DPAEntity.whb_emailaddressflag = true;
                    countOfSearchedValues = countOfSearchedValues + 1;
                    searchedValues = searchedValues + GlobalsearchEmail.trim() + ",";
                }
                if (GlobalsearchTelephone.trim() != '') {
                    DPAEntity.whb_telephoneflag = true;
                    countOfSearchedValues = countOfSearchedValues + 1;
                    searchedValues = searchedValues + GlobalsearchTelephone.trim() + ",";
                }
                if (GlobalsearchPostCode.trim() != '') {
                    DPAEntity.whb_postcodeflag = true;
                    countOfSearchedValues = countOfSearchedValues + 1;
                    searchedValues = searchedValues + GlobalsearchPostCode.trim() + ",";
                }
                DPAEntity.whb_searchedfieldvaluesindpa = searchedValues;
                DPAEntity.whb_countofsearchedfields = countOfSearchedValues;

                var caseParameters = getQueryVariable("Data");
                if (caseParameters.length > 20) {
                    DPAEntity["whb_Case@odata.bind"] = "/incidents(" + caseParameters.substr(11, caseParameters.length) + ")";
                    DPAEntity.whb_dpacreatedfromressearchcasescreenflag = true;
                }

                if (GlobalRoomNumber != "")
                    DPAEntity.whb_roomnumber = GlobalRoomNumber;
                // Create DPA entity
                CreateDPA(DPAEntity);
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "CheckDPAMainFunctin", err);
            }
        }

        // Create DPA entity
        // creae dpa with logged in user credentials
        function CreateDPA(DPAEntity) {
            try {
                $.ajax({
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    datatype: "json",
                    url: Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_dpachecks",
                    data: JSON.stringify(DPAEntity),
                    beforeSend: function (XMLHttpRequest) {
                        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                        XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    },
                    async: false,
                    success: function (data, textStatus, xhr) {
                        var uri = xhr.getResponseHeader("OData-EntityId");
                        var regExp = /\(([^)]+)\)/;
                        var matches = regExp.exec(uri);
                        var newEntityId = matches[1];

                        $('#loading').hide();
                        //window.open(Xrm.Page.context.getClientUrl() + "/main.aspx?etn=whb_dpacheck&pagetype=entityrecord&id=%7B" + newEntityId + "%7D", "_self");
                        Xrm.Utility.openEntityForm("whb_dpacheck", newEntityId);
                        window.close();
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        $('#loading').hide();
                        ErrorHandling("DPA Search", "DPA Search", "CreateDPA", xhr);
                    }
                });
            } catch (e) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "CreateDPA", e);
            }
        }

        function GuestDetailsForWalkins(reservatinNumber, guestRoomId, guestHistoryNumber, historyRecordNumber) {
            try {

                var roomType = "";
                var roomId = "";
                var adults = "";
                var childeren = "";
                var cot = "";
                var findGuest = "";
                var numberOfNights = 0;
                var invoice = 0;
                var contactName = "";
                var resAmount = 0;
                var currencyId = "";
                var RoomNumber = "";

                var reservationHistoryResponseXML = "";
                if (guestHistoryNumber != "" && historyRecordNumber != "")
                    reservationHistoryResponseXML = GetReservationHisotryQueriyDetailsForWalkin(guestHistoryNumber, historyRecordNumber);

                if (reservationHistoryResponseXML != "" && reservationHistoryResponseXML != null && reservationHistoryResponseXML != undefined) {
                    $(reservationHistoryResponseXML).find('booking').each(function () {
                        $(this).find('Invoice').each(function () {
                            var invoiceAmount = $(this).find('amount').text();
                            resAmount = Number(parseFloat(invoiceAmount).toFixed(4));
                            var userdCurreny = "";
                            userdCurreny = $(this).find('currency').text();
                            if (userdCurreny != "")
                                currencyId = GetCurrencyId(userdCurreny);
                        });

                        $(this).find('payments').each(function () {
                            $(this).find('Payment').each(function () {
                                var paymentObjectForRoom = new Object()
                                paymentObjectForRoom.paymentType = $(this).find('paymentType').text();
                                paymentObjectForRoom.cardType = $(this).find('cardType').text();
                                paymentObjectForRoom.cardNumber = $(this).find('cardNumber').text();
                                paymentObjectForRoom.expiryDate = $(this).find('expiryDate').text();
                                paymentObjectForRoom.paymentAmount = $(this).find('paymentAmount').text();
                                paymentObjectForRoom.cardHoldersName = $(this).find('cardHoldersName').text();
                                paymentObjectForRoom.currency = $(this).find('currency').text();
                                paymentsObject.push(paymentObjectForRoom);
                            });
                        });

                        $(this).find('rooms').each(function () {
                            $(this).find('Room').each(function () {
                                roomType = $(this).find('lettingType').text();
                                roomId = $(this).find('roomId').text();
                                RoomNumber = $(this).find('roomNumber').text();
                                GlobalRoomNumber = RoomNumber;
                                adults = $(this).find('adults').text();
                                childeren = $(this).find('children').text();
                                cot = $(this).find('cot').text();
                                $(this).find('guestName').each(function () {
                                    contactName = $(this).find('firstName').text() + " " + $(this).find('lastName').text();
                                });
                            });
                        });
                        $(this).find('costBreakdowns').each(function () {
                            $(this).find('CostBreakdown').each(function () {
                                //if (roomId == $(this).find('roomId').text()) {
                                    $(this).find('roomCharges').each(function () {
                                        $(this).find('RoomCharge').each(function () {
                                            numberOfNights = numberOfNights + 1;
                                        });
                                    });
                                //}
                            });
                        });
                    });
                }

                // if room number contains cr then it is a central refund.
                // For central refund there is no costbreak down available
                if (RoomNumber.toLowerCase().indexOf("cr") >= 0)
                {
                    return "";
                }

                //if (findGuest != "") {
                var entity = {};
                if (GlobalReservationId != "")
                    entity["whb_Reservation@odata.bind"] = "/whb_reservations(" + GlobalReservationId + ")";
                entity.whb_roomnumber = RoomNumber;
                entity.whb_roomtype = roomType;
                entity.whb_adultcount = adults;
                entity.whb_childrencount = childeren;
                entity.whb_cot = cot;
                entity.whb_numberofnights = numberOfNights;
                entity.whb_name = contactName;
                entity.whb_invoiceamount = resAmount;
                if (currencyId != "") {
                    entity["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + currencyId + ")";
                }
                else {
                    var transactioncurrencyidGBP = GetCurrencyId("GBP");
                    entity["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + transactioncurrencyidGBP + ")";
                }
                if (GlobalFeedBackData != "")
                    entity.whb_sitefeedback = GlobalFeedBackData;
                if (GlobalStayerId != "")
                    entity["whb_Contact@odata.bind"] = "/contacts(" + GlobalStayerId + ")";
                // create guest details
                CreateGuestDetails(entity, reservatinNumber, roomId, reservationHistoryResponseXML);

                // insert payments data
                if (GlobalGuestHistoryId != "") {
                    // delete guest payments and insert new once
                    DeletePaymentCards(GlobalGuestHistoryId);

                    for (let i = 0; i < paymentsObject.length; i++) {
                        var entityPaymentCard = {};
                        var obj = paymentsObject[i];
                        if (obj.paymentType != undefined && obj.paymentType != null)
                            entityPaymentCard.whb_name = obj.paymentType;
                        if (obj.cardType != undefined && obj.cardType != null)
                            entityPaymentCard.whb_cardtype = obj.cardType;
                        if (obj.cardNumber != undefined && obj.cardNumber != null)
                            entityPaymentCard.whb_cardnumber = obj.cardNumber;
                        if (obj.expiryDate != undefined && obj.expiryDate != null)
                            entityPaymentCard.whb_expirydate = obj.expiryDate;
                        if (obj.paymentAmount != undefined && obj.paymentAmount != null) {
                            var paymentAmountForInvoice = 0;
                            if (obj.paymentAmount != "")
                                paymentAmountForInvoice = obj.paymentAmount;
                            entityPaymentCard.whb_paymentamount = Number(parseFloat(paymentAmountForInvoice).toFixed(4));

                            if (obj.currency != undefined && obj.currency != null) {
                                var userdCurreny = obj.currency;
                                var paymenttransactioncurrencyid = GetCurrencyId(userdCurreny);
                                if (paymenttransactioncurrencyid != "") {
                                    entityPaymentCard["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + paymenttransactioncurrencyid + ")";
                                }
                                else {
                                    var transactioncurrencyidGBP = GetCurrencyId("GBP");
                                    entityPaymentCard["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + transactioncurrencyidGBP + ")";
                                }
                            }
                        }
                        if (obj.cardHoldersName != undefined && obj.cardHoldersName != null)
                            entityPaymentCard.whb_cardholdersname = obj.cardHoldersName;

                        entityPaymentCard["whb_guestname@odata.bind"] = "/whb_stayses(" + GlobalGuestHistoryId + ")";

                        CreatePaymentCardDetails(entityPaymentCard)
                    }
                }
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "GuestDetails", err);
            }
        }


        function GuestDetails(reservatinNumber, guestRoomId, guestHistoryNumber) {
            try {

                var roomType = "";
                var roomId = "";
                var adults = "";
                var childeren = "";
                var cot = "";
                var findGuest = "";
                var numberOfNights = 0;
                var invoice = 0;
                var contactName = "";
                var resAmount = 0;
                var currencyId = "";
                var RoomNumber = "";

                var reservationHistoryResponseXML = "";
                if (reservatinNumber != "" && guestRoomId != "")
                    reservationHistoryResponseXML = GetReservationHisotryQueriyDetails(reservatinNumber, "", guestRoomId);

                if (reservationHistoryResponseXML != "" && reservationHistoryResponseXML != null && reservationHistoryResponseXML != undefined) {
                    $(reservationHistoryResponseXML).find('booking').each(function () {
                        $(this).find('Invoice').each(function () {
                            var invoiceAmount = $(this).find('amount').text();
                            resAmount = Number(parseFloat(invoiceAmount).toFixed(4));
                            var userdCurreny = "";
                            userdCurreny = $(this).find('currency').text();
                            if (userdCurreny != "")
                                currencyId = GetCurrencyId(userdCurreny);
                        });

                        $(this).find('payments').each(function () {
                            $(this).find('Payment').each(function () {
                                var paymentObjectForRoom = new Object()
                                paymentObjectForRoom.paymentType = $(this).find('paymentType').text();
                                paymentObjectForRoom.cardType = $(this).find('cardType').text();
                                paymentObjectForRoom.cardNumber = $(this).find('cardNumber').text();
                                paymentObjectForRoom.expiryDate = $(this).find('expiryDate').text();
                                paymentObjectForRoom.paymentAmount = $(this).find('paymentAmount').text();
                                paymentObjectForRoom.cardHoldersName = $(this).find('cardHoldersName').text();
                                paymentObjectForRoom.currency = $(this).find('currency').text();
                                paymentsObject.push(paymentObjectForRoom);
                            });
                        });

                        $(this).find('rooms').each(function () {
                            $(this).find('Room').each(function () {
                                roomType = $(this).find('lettingType').text();
                                roomId = $(this).find('roomId').text();
                                RoomNumber = $(this).find('roomNumber').text();
                                GlobalRoomNumber = RoomNumber;
                                adults = $(this).find('adults').text();
                                childeren = $(this).find('children').text();
                                cot = $(this).find('cot').text();
                                $(this).find('guestName').each(function () {
                                    contactName = $(this).find('firstName').text() + " " + $(this).find('lastName').text();
                                });
                            });
                        });
                        $(this).find('costBreakdowns').each(function () {
                            $(this).find('CostBreakdown').each(function () {
                                if (roomId == $(this).find('roomId').text()) {
                                    $(this).find('roomCharges').each(function () {
                                        $(this).find('RoomCharge').each(function () {
                                            numberOfNights = numberOfNights + 1;
                                        });
                                    });
                                }
                            });
                        });
                    });
                }

                //if (findGuest != "") {
                var entity = {};
                if (GlobalReservationId != "")
                    entity["whb_Reservation@odata.bind"] = "/whb_reservations(" + GlobalReservationId + ")";
                entity.whb_roomnumber = RoomNumber;
                entity.whb_roomtype = roomType;
                entity.whb_adultcount = adults;
                entity.whb_childrencount = childeren;
                entity.whb_cot = cot;
                entity.whb_numberofnights = numberOfNights;
                entity.whb_name = contactName;
                entity.whb_invoiceamount = resAmount;
                if (currencyId != "") {
                    entity["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + currencyId + ")";
                }
                else {
                    var transactioncurrencyidGBP = GetCurrencyId("GBP");
                    entity["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + transactioncurrencyidGBP + ")";
                }
                if (GlobalFeedBackData != "")
                    entity.whb_sitefeedback = GlobalFeedBackData;
                if (GlobalStayerId != "")
                    entity["whb_Contact@odata.bind"] = "/contacts(" + GlobalStayerId + ")";
                // create guest details
                CreateGuestDetails(entity, reservatinNumber, roomId, reservationHistoryResponseXML);

                // insert payments data
                if (GlobalGuestHistoryId != "") {
                    // delete guest payments and insert new once
                    DeletePaymentCards(GlobalGuestHistoryId);

                    for (let i = 0; i < paymentsObject.length; i++) {
                        var entityPaymentCard = {};
                        var obj = paymentsObject[i];
                        if (obj.paymentType != undefined && obj.paymentType != null)
                            entityPaymentCard.whb_name = obj.paymentType;
                        if (obj.cardType != undefined && obj.cardType != null)
                            entityPaymentCard.whb_cardtype = obj.cardType;
                        if (obj.cardNumber != undefined && obj.cardNumber != null)
                            entityPaymentCard.whb_cardnumber = obj.cardNumber;
                        if (obj.expiryDate != undefined && obj.expiryDate != null)
                            entityPaymentCard.whb_expirydate = obj.expiryDate;
                        if (obj.paymentAmount != undefined && obj.paymentAmount != null) {
                            var paymentAmountForInvoice = 0;
                            if (obj.paymentAmount != "")
                                paymentAmountForInvoice = obj.paymentAmount;
                            entityPaymentCard.whb_paymentamount = Number(parseFloat(paymentAmountForInvoice).toFixed(4));

                            if (obj.currency != undefined && obj.currency != null) {
                                var userdCurreny = obj.currency;
                                var paymenttransactioncurrencyid = GetCurrencyId(userdCurreny);
                                if (paymenttransactioncurrencyid != "") {
                                    entityPaymentCard["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + paymenttransactioncurrencyid + ")";
                                }
                                else {
                                    var transactioncurrencyidGBP = GetCurrencyId("GBP");
                                    entityPaymentCard["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + transactioncurrencyidGBP + ")";
                                }
                            }
                        }
                        if (obj.cardHoldersName != undefined && obj.cardHoldersName != null)
                            entityPaymentCard.whb_cardholdersname = obj.cardHoldersName;

                        entityPaymentCard["whb_guestname@odata.bind"] = "/whb_stayses(" + GlobalGuestHistoryId + ")";

                        CreatePaymentCardDetails(entityPaymentCard)
                    }
                }
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "GuestDetails", err);
            }
        }

        function CreatePaymentCardDetails(entity) {
            try {
                if (MSCRMCallerID == "")
                    GetConfiguratoinValues();

                $.ajax({
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    datatype: "json",
                    url: Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_guestpaymentses",
                    data: JSON.stringify(entity),
                    beforeSend: function (XMLHttpRequest) {
                        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                        XMLHttpRequest.setRequestHeader("Accept", "application/json");
                        XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                    },
                    async: true,
                    success: function (data, textStatus, xhr) {
                        var uri = xhr.getResponseHeader("OData-EntityId");
                        var regExp = /\(([^)]+)\)/;
                        var matches = regExp.exec(uri);
                        var newEntityId = matches[1];
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        //Xrm.Utility.alertDialog(textStatus + " " + errorThrown);
                        ErrorHandling("DPA Search", "DPA Search", "DeletePaymentCards", xhr);
                    }
                });

            } catch (e) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "CreatePaymentCardDetails", e);

            }
        }

        function DeletePaymentCards(guestId) {

            try {

                if (MSCRMCallerID == "")
                    GetConfiguratoinValues();

                $.ajax({
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    datatype: "json",
                    url: Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_guestpaymentses?$filter=_whb_guestname_value eq " + guestId,
                    beforeSend: function (XMLHttpRequest) {
                        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                        XMLHttpRequest.setRequestHeader("Accept", "application/json");
                        XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                        XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                    },
                    async: false,
                    success: function (data, textStatus, xhr) {
                        var results = data;
                        for (var i = 0; i < results.value.length; i++) {
                            var whb_guestpaymentsid = results.value[i]["whb_guestpaymentsid"];
                            DeletePayment(whb_guestpaymentsid)
                        }
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        //Xrm.Utility.alertDialog(textStatus + " " + errorThrown);
                        ErrorHandling("DPA Search", "DPA Search", "DeletePaymentCards", xhr);
                    }
                });

            } catch (e) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "DeletePaymentCards", e);
            }
        }

        function DeletePayment(paymentId) {
            try {
                if (MSCRMCallerID == "")
                    GetConfiguratoinValues();
                $.ajax({
                    type: "DELETE",
                    contentType: "application/json; charset=utf-8",
                    datatype: "json",
                    url: Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_guestpaymentses(" + paymentId + ")",
                    beforeSend: function (XMLHttpRequest) {
                        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                        XMLHttpRequest.setRequestHeader("Accept", "application/json");
                        XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                    },
                    async: true,
                    success: function (data, textStatus, xhr) {
                        //Success - No Return Data - Do Something
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        // Xrm.Utility.alertDialog(textStatus + " " + errorThrown);
                        ErrorHandling("DPA Search", "DPA Search", "DeletePaymentCards", xhr);
                    }
                });

            } catch (e) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "DeletePayment", e);
            }
        }

        // Create or update stayer details
        function CreateGuestDetails(entity, reservatinNumber, roomNumber, reservationHistoryResponseXML) {

            try {

                var guestDetailName = entity.whb_name;

                var guestDetailsId = "";
                guestDetailsId = checkGuestDetailsExists();
                var type = "";
                var URL = "";
                if (guestDetailsId != "") {
                    type = "PATCH";
                    URL = Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_stayses(" + guestDetailsId + ")";
                }
                else {
                    type = "POST";
                    URL = Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_stayses";
                }

                if (MSCRMCallerID == "")
                    GetConfiguratoinValues();

                $.ajax({
                    type: type,
                    contentType: "application/json; charset=utf-8",
                    datatype: "json",
                    url: URL,
                    data: JSON.stringify(entity),
                    beforeSend: function (XMLHttpRequest) {
                        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                        XMLHttpRequest.setRequestHeader("Accept", "application/json");
                        XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                    },
                    async: false,
                    success: function (data, textStatus, xhr) {
                        if (guestDetailsId == "") {
                            var uri = xhr.getResponseHeader("OData-EntityId");
                            var regExp = /\(([^)]+)\)/;
                            var matches = regExp.exec(uri);
                            guestDetailsId = matches[1];
                            GlobalGuestHistoryId = guestDetailsId;
                        }

                        GlobalGuestHistoryId = guestDetailsId;
                        // create room details
                        if (guestDetailsId != "")
                            CreateRoomDetails(guestDetailsId, guestDetailName, roomNumber, reservationHistoryResponseXML);
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        $('#loading').hide();
                        ErrorHandling("DPA Search", "DPA Search", "CreateGuestDetails", xhr);

                    }
                });
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "CreateGuestDetails", err);
            }
        }

        function CreateRoomDetails(guestDetailsId, guestDetailName, roomNumber, reservationHistoryResponseXML) {
            try {
                var entity = {};
                entity["whb_Reservation@odata.bind"] = "/whb_reservations(" + GlobalReservationId + ")";
                entity.whb_name = guestDetailName;
                entity["whb_Stay@odata.bind"] = "/whb_stayses(" + guestDetailsId + ")";
                entity["whb_Contact@odata.bind"] = "/contacts(" + GlobalStayerId + ")";

                $(reservationHistoryResponseXML).find('booking').each(function () {
                    $(this).find('costBreakdowns').each(function () {
                        $(this).find('CostBreakdown').each(function () {
                            var roomId = $(this).find('roomId').text();
                            // if (roomId == roomNumber) { // we are searching from room id
                            $(this).find('roomCharges').each(function () {
                                $(this).find('RoomCharge').each(function () {
                                    var costPerNight = $(this).find('amount').text();
                                    if (costPerNight != null && costPerNight != "" && costPerNight != undefined) {
                                        entity.whb_costpernight1 = Number(parseFloat(costPerNight).toFixed(4));
                                        var userdCurreny = $(this).find('currency').text();

                                        var transactioncurrencyid = GetCurrencyId(userdCurreny);

                                        if (transactioncurrencyid != "") {
                                            entity["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + transactioncurrencyid + ")";
                                        }
                                        else {
                                            var transactioncurrencyidGBP = GetCurrencyId("GBP");
                                            entity["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + transactioncurrencyidGBP + ")";
                                        }
                                    }
                                    else {
                                        entity.whb_costpernight1 = Number(parseFloat(0).toFixed(4));
                                    }

                                    var roomDate = $(this).find('date').text();
                                    if (roomDate != null && roomDate != "" && roomDate != undefined)
                                        entity.whb_dateofstay = new Date(roomDate);
                                    CreateRoomStayDetails(entity, GlobalReservationId, GlobalStayerId, guestDetailsId, roomDate);
                                });
                            });
                            // }
                        });
                    });
                });
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "CreateRoomDetails", err);
            }
        }

        // create or update room stay details in crm
        function CreateRoomStayDetails(entity, reservatinEntityId, contactid, guestDetailsId, roomDate) {
            try {

                if (MSCRMCallerID == "")
                    GetConfiguratoinValues();
                var checkRoomstaysesExists = "";
                checkRoomstaysesExists = CheckRoomStayDetailsExists(reservatinEntityId, contactid, guestDetailsId, roomDate);

                var type = "";
                var URL = "";

                if (checkRoomstaysesExists != "") {
                    type = "PATCH";
                    URL = Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_roomstayses(" + checkRoomstaysesExists + ")";
                } else {
                    type = "POST";
                    URL = Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_roomstayses";
                }

                $.ajax({
                    type: type,
                    contentType: "application/json; charset=utf-8",
                    datatype: "json",
                    url: URL,
                    data: JSON.stringify(entity),
                    beforeSend: function (XMLHttpRequest) {
                        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                        XMLHttpRequest.setRequestHeader("Accept", "application/json");
                        XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                    },
                    async: true,
                    success: function (data, textStatus, xhr) {
                        if (checkRoomstaysesExists == "") {
                            var uri = xhr.getResponseHeader("OData-EntityId");
                            var regExp = /\(([^)]+)\)/;
                            var matches = regExp.exec(uri);
                            var newEntityId = matches[1];
                        }
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        $('#loading').hide();
                        ErrorHandling("DPA Search", "DPA Search", "CreateRoomStayDetails", xhr);

                    }
                });
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "CreateRoomStayDetails", err);

            }
        }

        // check room stayer details exists or not in crm
        function CheckRoomStayDetailsExists(reservatinEntityId, contactId, ContactDetailsId, stayDate) {
            var roomStay = "";
            if (MSCRMCallerID == "")
                GetConfiguratoinValues();
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_roomstayses?$select=whb_roomstaysid&$filter=_whb_reservation_value eq " + reservatinEntityId + " and _whb_contact_value eq " + contactId + " and _whb_stay_value eq " + ContactDetailsId + " and whb_dateofstay eq " + stayDate + "T00:00:00Z",
                beforeSend: function (XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                    XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                },
                async: false,
                success: function (data, textStatus, xhr) {
                    var results = data;
                    for (var i = 0; i < results.value.length; i++) {
                        var whb_roomstaysid = results.value[i]["whb_roomstaysid"];
                        roomStay = whb_roomstaysid;
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    $('#loading').hide();
                    ErrorHandling("DPA Search", "DPA Search", "CheckRoomStayDetailsExists", xhr);
                }
            });
            return roomStay;
        }


        // Check stayer details exists or not in crm
        function checkGuestDetailsExists() {
            var guestDetailsId = "";
            if (MSCRMCallerID == "")
                GetConfiguratoinValues();
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_stayses?$select=whb_staysid&$filter=_whb_contact_value eq " + GlobalStayerId + " and _whb_reservation_value eq " + GlobalReservationId,
                beforeSend: function (XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                    XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                },
                async: false,
                success: function (data, textStatus, xhr) {
                    var results = data;
                    for (var i = 0; i < results.value.length; i++) {
                        var whb_staysid = results.value[i]["whb_staysid"];
                        guestDetailsId = whb_staysid;
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    $('#loading').hide();
                    ErrorHandling("DPA Search", "DPA Search", "checkGuestDetailsExists", xhr);
                }
            });
            return guestDetailsId;
        }

        // Get currency Id
        function GetCurrencyId(currencyCode) {
            if (MSCRMCallerID == "")
                GetConfiguratoinValues();
            var currencyId = "";
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: Xrm.Page.context.getClientUrl() + "/api/data/v8.2/transactioncurrencies?$select=transactioncurrencyid&$filter=isocurrencycode eq '" + currencyCode + "'",
                beforeSend: function (XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                },
                async: false,
                success: function (data, textStatus, xhr) {
                    var results = data;
                    for (var i = 0; i < results.value.length; i++) {
                        currencyId = results.value[i]["transactioncurrencyid"];
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    $('#loading').hide();
                    ErrorHandling("DPA Search", "DPA Search", "GetCurrencyId", xhr);
                }
            });
            return currencyId;
        }

        //Create or update reservation in crm
        function CreateReservationForWalkin(reservatinNumber, guestHistoryNumber, roomId, PrivateOrBusinessAddress, thirdPartyBookingReference,historyRecordNumber) {
            try {

                var reservationEntityId = "";

                reservationEntityId = CheckReservationExists(guestHistoryNumber + "-" + historyRecordNumber + "-Walkin");
                var PropertyId = "";
                var numberOfRooms = 0;
                var numberOfNights = 0;
                var bookerGuestHistoryNumber = "";
                var entity = {};
                entity.whb_name = guestHistoryNumber + "-" + historyRecordNumber + "-Walkin";
                var arrivalDate = "";
                var deptDate = "";
                // Get reservtion data

                var responseXML = GetReservationHisotryQueriyDetailsForWalkin(guestHistoryNumber, historyRecordNumber);

                GlobalReservationNumber = guestHistoryNumber + "-" + historyRecordNumber + "-Walkin";

                $(responseXML).find('booking').each(function () {

                    if ($(this).find('arrivalDate').text() != "")
                        arrivalDate = new Date($(this).find('arrivalDate').text());

                    if ($(this).find('departureDate').text() != "")
                        deptDate = new Date($(this).find('departureDate').text());

                    GlobalArrivalDate = arrivalDate;
                    GlobalDepartureDate = deptDate;

                    if ($(this).find('hotelCode').text() != "")
                        PropertyId = GetPropertyId($(this).find('hotelCode').text());

                    GlobalPropertyId = PropertyId;

                    if (PropertyId != "")
                        entity["whb_HotelName@odata.bind"] = "/whb_properties(" + PropertyId + ")";

                    if ($(this).find('arrivalDate').text() != "")
                        entity.whb_arrivaldate = new Date($(this).find('arrivalDate').text());

                    if ($(this).find('departureDate').text() != "")
                        entity.whb_departuredate = new Date($(this).find('departureDate').text());

                    //if ($(this).find('bookingDate').text() != "")
                    //    entity.whb_paymentdate = new Date($(this).find('bookingDate').text());


                    // Promotion
                    $(this).find('promotion').each(function () {
                        entity.whb_promotion = $(this).find('code').text() + " " + $(this).find('description').text();
                    });

                    // Booking Method
                    $(this).find('bookingMethod').each(function () {
                        entity.whb_bookingmethods = $(this).find('code').text() + " " + $(this).find('description').text();
                    });

                    // Get Number of rooms
                    $(this).find('rooms').each(function () {
                        $(this).find('Room').each(function () {
                            numberOfRooms = numberOfRooms + 1;
                        });
                    });

                    $(this).find('booker').each(function () {
                        bookerGuestHistoryNumber = $(this).find('guestHistoryNumber').text();
                    });
                });

                if (deptDate != "" && arrivalDate != "")
                    numberOfNights = showDays(deptDate, arrivalDate);

                // number of rooms
                entity.whb_numberofrooms = numberOfRooms;

                // third party booking reference
                if (thirdPartyBookingReference != "")
                    entity.whb_thirdpartybookingref = thirdPartyBookingReference;

                // number of nights
                if (numberOfNights != undefined && numberOfNights != "" && numberOfNights != null)
                    entity.whb_numberofnights = numberOfNights;

                // Create reservation
                reservatinEntityId = CreateReservationInCRM(entity, reservationEntityId)

                GlobalReservationId = reservatinEntityId;

               // if (bookerGuestHistoryNumber == guestHistoryNumber)
                    GlobalBookerAndStayerAreSame = true;
                    //return;
                // Create booker informaton
                if (reservatinEntityId != "")
                    GetGuestDetailsofReservationForBooker(reservatinNumber, guestHistoryNumber, PrivateOrBusinessAddress, reservatinEntityId, roomId, "booker");
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "CreateReservation", xhr);
            }
        }

        //Create or update reservation in crm
        function CreateReservation(reservatinNumber, guestHistoryNumber, roomId, PrivateOrBusinessAddress, thirdPartyBookingReference) {
            try {

                var reservationEntityId = "";

                reservationEntityId = CheckReservationExists(reservatinNumber);
                var PropertyId = "";
                var numberOfRooms = 0;
                var numberOfNights = 0;
                var bookerGuestHistoryNumber = "";
                var entity = {};
                entity.whb_name = reservatinNumber;
                var arrivalDate = "";
                var deptDate = "";
                //var paymentDate = "";
                //invoiceDate
                // Get reservtion data

                var responseXML = GetReservationHisotryQueriyDetails(reservatinNumber, "", "");

                GlobalReservationNumber = reservatinNumber;

                $(responseXML).find('booking').each(function () {

                    if ($(this).find('arrivalDate').text() != "")
                        arrivalDate = new Date($(this).find('arrivalDate').text());

                    if ($(this).find('departureDate').text() != "")
                        deptDate = new Date($(this).find('departureDate').text());

                    GlobalArrivalDate = arrivalDate;
                    GlobalDepartureDate = deptDate;

                    if ($(this).find('hotelCode').text() != "")
                        PropertyId = GetPropertyId($(this).find('hotelCode').text());

                    GlobalPropertyId = PropertyId;

                    if (PropertyId != "")
                        entity["whb_HotelName@odata.bind"] = "/whb_properties(" + PropertyId + ")";

                    if ($(this).find('arrivalDate').text() != "")
                        entity.whb_arrivaldate = new Date($(this).find('arrivalDate').text());

                    if ($(this).find('departureDate').text() != "")
                        entity.whb_departuredate = new Date($(this).find('departureDate').text());

                    //if ($(this).find('bookingDate').text() != "")
                    //    entity.whb_paymentdate = new Date($(this).find('bookingDate').text());

                    // Promotion
                    $(this).find('promotion').each(function () {
                        entity.whb_promotion = $(this).find('code').text() + " " + $(this).find('description').text();
                    });

                    // Booking Method
                    $(this).find('bookingMethod').each(function () {
                        entity.whb_bookingmethods = $(this).find('code').text() + " " + $(this).find('description').text();
                    });

                    // Get Number of rooms
                    $(this).find('rooms').each(function () {
                        $(this).find('Room').each(function () {
                            numberOfRooms = numberOfRooms + 1;
                        });
                    });

                    $(this).find('booker').each(function () {
                        bookerGuestHistoryNumber = $(this).find('guestHistoryNumber').text();
                    });
                });

                if (deptDate != "" && arrivalDate != "")
                    numberOfNights = showDays(deptDate, arrivalDate);

                // number of rooms
                entity.whb_numberofrooms = numberOfRooms;

                // third party booking reference
                if (thirdPartyBookingReference != "")
                    entity.whb_thirdpartybookingref = thirdPartyBookingReference;

                // number of nights
                if (numberOfNights != undefined && numberOfNights != "" && numberOfNights != null)
                    entity.whb_numberofnights = numberOfNights;

                // Create reservation
                reservatinEntityId = CreateReservationInCRM(entity, reservationEntityId)

                GlobalReservationId = reservatinEntityId;

                if (bookerGuestHistoryNumber == guestHistoryNumber)
                    GlobalBookerAndStayerAreSame = true;

                // Create booker informaton
                if (reservatinEntityId != "")
                    GetGuestDetailsofReservationForBooker(reservatinNumber, bookerGuestHistoryNumber, PrivateOrBusinessAddress, reservatinEntityId, roomId, "booker");
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "CreateReservation", xhr);
            }
        }

        // create contact if there is no guest history number present
        function GetGuestDetailsofReservationWithoutGuestHistoryNumber(reservatinNumber, guestRoomId, GlobalReservationId) {
            try {

                var responseXML = GetReservationHisotryQueriyDetails(reservatinNumber, "", guestRoomId);
                var title = "";
                var firstName = "";
                var lastName = "";
                $(responseXML).find('booking').each(function () {
                    $(this).find('rooms').each(function () {
                        $(this).find('Room').each(function () {
                            $(this).find('guestName').each(function () {
                                firstName = $(this).find('firstName').text();
                                lastName = $(this).find('lastName').text();
                                title = $(this).find('title').text();
                            });
                        });
                    });
                });

                //// Create stayer in crm
                //if (lastName == "")
                //    lastName = reservatinNumber;
                CreateContact(title, "", GlobalReservationId, firstName, lastName, "", "", "", "", "", "", "", "", "", "", "", "", "", reservatinNumber, guestRoomId);
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "GetGuestDetailsofReservationWithoutGuestHistoryNumber", err);
            }
        }

        // get details from guest history query and insert into contact entity
        function GetGuestDetailsofReservationForBooker(reservatinNumber, guestHistoryNumber, PrivateOrBusinessAddress, reservationEntityId, roomId, BookerOrStayer) {
            try {

                var xmlGuestHistoryresponse = ""; // Get Guest History details from BART
                if (guestHistoryNumber != "")
                    xmlGuestHistoryresponse = GetGuestHisotryQueriyDetails(guestHistoryNumber)

                var firstName = "";
                var lastName = "";
                var addressLine1 = "";
                var addressLine2 = "";
                var addressLine3 = "";
                var countryCode = "";
                var postCode = "";
                var emailAddress = "";
                var mobileNumber = "";
                var telephoneNumber = "";
                var guestHistoryNumber = guestHistoryNumber;
                var companyName = "";
                var companyCode = "";
                var addressType = "";
                var title = "";

                $(xmlGuestHistoryresponse).find('guestDetails').each(function () {
                    firstName = $(this).find('firstName').text();
                    lastName = $(this).find('lastName').text();
                    title = $(this).find('title').text();

                    if (PrivateOrBusinessAddress == "") {
                        addressType = 1;
                        $(this).find('homeAddress').each(function () {
                            addressLine1 = $(this).find('addressLine1').text();
                            addressLine2 = $(this).find('addressLine2').text();
                            addressLine3 = $(this).find('addressLine3').text();
                            countryCode = $(this).find('countryCode').text();
                            postCode = $(this).find('postCode').text();
                            emailAddress = $(this).find('emailId').text();
                            $(this).find('telephoneNumbers').each(function () {
                                $(this).find('Telephone').each(function () {
                                    if ($(this).find('numberType').text() == 'MOBILE')
                                        mobileNumber = $(this).find('telephoneNumber').text();
                                    if ($(this).find('numberType').text() == 'TELEPHONE')
                                        telephoneNumber = $(this).find('telephoneNumber').text();
                                });
                            });
                        });
                    } else if (PrivateOrBusinessAddress == 'P') {
                        addressType = 1;
                        $(this).find('homeAddress').each(function () {
                            addressLine1 = $(this).find('addressLine1').text();
                            addressLine2 = $(this).find('addressLine2').text();
                            addressLine3 = $(this).find('addressLine3').text();
                            countryCode = $(this).find('countryCode').text();
                            postCode = $(this).find('postCode').text();
                            emailAddress = $(this).find('emailId').text();
                            $(this).find('telephoneNumbers').each(function () {
                                $(this).find('Telephone').each(function () {
                                    if ($(this).find('numberType').text() == 'MOBILE')
                                        mobileNumber = $(this).find('telephoneNumber').text();
                                    if ($(this).find('numberType').text() == 'TELEPHONE')
                                        telephoneNumber = $(this).find('telephoneNumber').text();
                                });
                            });
                        });
                    } else {
                        addressType = 2;
                        $(this).find('businessAddress').each(function () {
                            addressLine1 = $(this).find('addressLine1').text();
                            addressLine2 = $(this).find('addressLine2').text();
                            addressLine3 = $(this).find('addressLine3').text();
                            countryCode = $(this).find('countryCode').text();
                            postCode = $(this).find('postCode').text();
                            emailAddress = $(this).find('emailId').text();
                            //alert("companyName "+companyName);
                            companyName = $(this).find('companyName').text();
                            companyCode = $(this).find('companyId').text();
                            //alert("companyCode "+companyCode);
                            $(this).find('telephoneNumbers').each(function () {
                                $(this).find('Telephone').each(function () {
                                    if ($(this).find('numberType').text() == 'MOBILE')
                                        mobileNumber = $(this).find('telephoneNumber').text();
                                    if ($(this).find('numberType').text() == 'TELEPHONE')
                                        telephoneNumber = $(this).find('telephoneNumber').text();
                                });
                            });
                        });
                    }
                });

                // getting site feedback
                //GlobalFeedBackData = "";
                if (guestHistoryNumber != "") {
                    $(xmlGuestHistoryresponse).find('feedbacks').each(function () {
                        $(this).find('QueryGuestFeedback').each(function () {
                            if ($(this).find('reservationNumber').text() == reservatinNumber) {
                                var feedBackNumber = "";
                                feedBackNumber = $(this).find('refNumber').text();
                                if (feedBackNumber != "") {
                                    GlobalFeedBackData = GlobalFeedBackData + GetFeedBackDetails(guestHistoryNumber, feedBackNumber);
                                }
                            }
                        });
                    });
                }

                var companyId = "";
                if (companyCode != '' && companyCode != "" && companyCode != null && companyCode != undefined)
                    companyId = GetCompanyInformation(companyCode, companyName); // Creating Account

                // Create stayer in crm
                CreateContact(title, companyId, reservationEntityId, firstName, lastName, emailAddress, mobileNumber, telephoneNumber, guestHistoryNumber, companyName, companyId, addressLine1, addressLine2, addressLine3, countryCode, postCode, addressType, "booker", reservatinNumber, roomId);
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "GetGuestDetailsofReservation", err);
            }
        }


        // get details from guest history query and insert into contact entity
        function GetGuestDetailsofReservation(reservatinNumber, guestHistoryNumber, PrivateOrBusinessAddress, reservationEntityId, BookerOrStayer) {
            try {

                var xmlGuestHistoryresponse = GetGuestHisotryQueriyDetails(guestHistoryNumber); // Get Guest History details from BART

                var firstName = "";
                var lastName = "";
                var addressLine1 = "";
                var addressLine2 = "";
                var addressLine3 = "";
                var countryCode = "";
                var postCode = "";
                var emailAddress = "";
                var mobileNumber = "";
                var telephoneNumber = "";
                var guestHistoryNumber = guestHistoryNumber;
                var companyName = "";
                var companyCode = "";
                var addressType = "";
                var title = "";

                $(xmlGuestHistoryresponse).find('guestDetails').each(function () {
                    firstName = $(this).find('firstName').text();
                    lastName = $(this).find('lastName').text();
                    title = $(this).find('title').text();

                    if (PrivateOrBusinessAddress == "") {
                        addressType = 1;
                        $(this).find('homeAddress').each(function () {
                            addressLine1 = $(this).find('addressLine1').text();
                            addressLine2 = $(this).find('addressLine2').text();
                            addressLine3 = $(this).find('addressLine3').text();
                            countryCode = $(this).find('countryCode').text();
                            postCode = $(this).find('postCode').text();
                            emailAddress = $(this).find('emailId').text();
                            $(this).find('telephoneNumbers').each(function () {
                                $(this).find('Telephone').each(function () {
                                    if ($(this).find('numberType').text() == 'MOBILE')
                                        mobileNumber = $(this).find('telephoneNumber').text();
                                    if ($(this).find('numberType').text() == 'TELEPHONE')
                                        telephoneNumber = $(this).find('telephoneNumber').text();
                                });
                            });
                        });
                    } else if (PrivateOrBusinessAddress == 'P') {
                        addressType = 1;
                        $(this).find('homeAddress').each(function () {
                            addressLine1 = $(this).find('addressLine1').text();
                            addressLine2 = $(this).find('addressLine2').text();
                            addressLine3 = $(this).find('addressLine3').text();
                            countryCode = $(this).find('countryCode').text();
                            postCode = $(this).find('postCode').text();
                            emailAddress = $(this).find('emailId').text();
                            $(this).find('telephoneNumbers').each(function () {
                                $(this).find('Telephone').each(function () {
                                    if ($(this).find('numberType').text() == 'MOBILE')
                                        mobileNumber = $(this).find('telephoneNumber').text();
                                    if ($(this).find('numberType').text() == 'TELEPHONE')
                                        telephoneNumber = $(this).find('telephoneNumber').text();
                                });
                            });
                        });
                    } else {
                        addressType = 2;
                        $(this).find('businessAddress').each(function () {
                            addressLine1 = $(this).find('addressLine1').text();
                            addressLine2 = $(this).find('addressLine2').text();
                            addressLine3 = $(this).find('addressLine3').text();
                            countryCode = $(this).find('countryCode').text();
                            postCode = $(this).find('postCode').text();
                            emailAddress = $(this).find('emailId').text();
                            //alert("companyName "+companyName);
                            companyName = $(this).find('companyName').text();
                            companyCode = $(this).find('companyId').text();
                            //alert("companyCode "+companyCode);
                            $(this).find('telephoneNumbers').each(function () {
                                $(this).find('Telephone').each(function () {
                                    if ($(this).find('numberType').text() == 'MOBILE')
                                        mobileNumber = $(this).find('telephoneNumber').text();
                                    if ($(this).find('numberType').text() == 'TELEPHONE')
                                        telephoneNumber = $(this).find('telephoneNumber').text();
                                });
                            });
                        });
                    }
                });

                //GlobalFeedBackData = "";
                if (guestHistoryNumber != "") {
                    $(xmlGuestHistoryresponse).find('feedbacks').each(function () {
                        $(this).find('QueryGuestFeedback').each(function () {
                            if ($(this).find('reservationNumber').text() == reservatinNumber) {
                                var feedBackNumber = "";
                                feedBackNumber = $(this).find('refNumber').text();
                                if (feedBackNumber != "") {
                                    GlobalFeedBackData = GlobalFeedBackData + GetFeedBackDetails(guestHistoryNumber, feedBackNumber);
                                }
                            }
                        });
                    });
                }

                var companyId = "";
                if (companyCode != '' && companyCode != "" && companyCode != null && companyCode != undefined)
                    companyId = GetCompanyInformation(companyCode, companyName); // Creating Account

                // Create stayer in crm
                CreateContact(title, companyId, reservationEntityId, firstName, lastName, emailAddress, mobileNumber, telephoneNumber, guestHistoryNumber, companyName, companyId, addressLine1, addressLine2, addressLine3, countryCode, postCode, addressType, BookerOrStayer, "", "");
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "GetGuestDetailsofReservation", err);
            }
        }

        // Create contact in crm
        function CreateContact(title, companyId, reservationEntityId, firstName, lastName, emailAddress, mobileNumber, telephoneNumber, guestHistoryNumber, companyName, companyId, addressLine1, addressLine2, addressLine3, countryCode, postCode, addressType, BookerOrStayer, reservationNumber, guestRoomId) {
            try {

                var contactid = "";

                if (GlobalReservationNumber != "")
                    if (firstName == "" && lastName == "" && BookerOrStayer == "booker") {
                        var responseXMLForBooker = GetReservationHisotryQueriyDetails(GlobalReservationNumber, "", "");

                        $(responseXMLForBooker).find('booker').each(function () {
                            title = $(this).find('tile').text();
                            firstName = $(this).find('firstName').text();
                            lastName = $(this).find('lastName').text();
                            emailAddress = $(this).find('emailAddress').text();
                            mobileNumber = $(this).find('mobileNumber').text();
                            telephoneNumber = $(this).find('telephoneNumber').text();

                            $(this).find('address').each(function () {
                                addressLine1 = $(this).find('addressLine1').text();
                                addressLine2 = $(this).find('addressLine2').text();
                                addressLine3 = $(this).find('addressLine3').text();
                                countryCode = $(this).find('countryCode').text();
                                postCode = $(this).find('postCode').text();
                            });
                        });
                    }
                if (firstName == "" && lastName == "" && BookerOrStayer == "booker")
                    return GlobalBookerId = "";
                else if (firstName == "" && lastName == "" && BookerOrStayer != "booker")
                    return GlobalStayerId = "";

                contactid = CheckContactExists(guestHistoryNumber, reservationNumber, guestRoomId, firstName);// check guest history number already present in contact
                var type = "";
                var URL = "";
                if (contactid == "") {
                    type = 'POST';
                    URL = Xrm.Page.context.getClientUrl() + "/api/data/v8.2/contacts";
                }
                else {
                    type = 'PATCH';
                    URL = Xrm.Page.context.getClientUrl() + "/api/data/v8.2/contacts(" + contactid + ")";
                }

                var entity = {};
                var titleValue = Title(title);// get title for contact
                if (titleValue != 12)
                    entity.whb_title1 = titleValue;
                if (firstName != "")
                    entity.firstname = firstName;
                if (lastName != "")
                    entity.lastname = lastName;
                if (addressLine1 != "")
                    entity.address1_line1 = addressLine1;
                if (addressLine2 != "")
                    entity.address1_line2 = addressLine2;
                if (addressLine3 != "")
                    entity.address1_line3 = addressLine3;
                if (countryCode != "")
                    entity.address1_country = countryCode;
                if (postCode != "")
                    entity.address1_postalcode = postCode;
                if (mobileNumber != "")
                    entity.mobilephone = mobileNumber;
                if (telephoneNumber != "")
                    entity.telephone1 = telephoneNumber;
                if (emailAddress != "")
                    entity.emailaddress1 = emailAddress;

                if (guestHistoryNumber != "") {
                    entity.whb_guesthistorynumber = guestHistoryNumber;
                } else if (reservationNumber != "" ) { // there is no guest history number then save reservation number and roomid
                    if (reservationNumber != "")
                        entity.whb_reservationnumber = reservationNumber;
                    if (guestRoomId != "")
                        entity.whb_roomid = guestRoomId;
                }

                if (addressType != "")
                    entity.whb_addresstype = addressType;

                if (companyId != '')
                    entity["parentcustomerid_account@odata.bind"] = "/accounts(" + companyId + ")";

                if (MSCRMCallerID == "")
                    GetConfiguratoinValues();

                $.ajax({
                    type: type,
                    contentType: "application/json; charset=utf-8",
                    datatype: "json",
                    url: URL,
                    data: JSON.stringify(entity),
                    beforeSend: function (XMLHttpRequest) {
                        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                        XMLHttpRequest.setRequestHeader("Accept", "application/json");
                        XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                    },
                    async: false,
                    success: function (data, textStatus, xhr) {
                        if (contactid == "") {
                            var uri = xhr.getResponseHeader("OData-EntityId");
                            var regExp = /\(([^)]+)\)/;
                            var matches = regExp.exec(uri);
                            var newEntityId = matches[1];
                            contactid = newEntityId;
                            if (BookerOrStayer != "booker")
                                GlobalStayerId = contactid;
                            //if (guestHistoryNumber != "")
                            if (reservationEntityId != "")
                                AssociateReservationWithContact(reservationEntityId, contactid);
                        }

                        if (BookerOrStayer == "booker") {
                            // pass booker details to dpa check
                            GlobalAddress = addressLine1;
                            GlobalPostalCode = postCode;
                            if (telephoneNumber != "" && mobileNumber != "")
                                GlobalphoneNumber = telephoneNumber + " / " + mobileNumber;
                            else if (telephoneNumber != "")
                                GlobalphoneNumber = telephoneNumber;
                            else if (mobileNumber != "")
                                GlobalphoneNumber = mobileNumber;
                            GlobalEmailAddressTab = emailAddress;
                            GlobalBookerId = contactid;
                            UpdateReservationWithBooker(contactid, reservationEntityId);
                        }
                        else
                            GlobalStayerId = contactid;
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        $('#loading').hide();
                        ErrorHandling("DPA Search", "DPA Search", "CreateContactForStayer", xhr);
                    }
                });
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "CreateContact", err);
            }
        }

        // Title for contact
        function Title(title) {
            if (title == "" || title == '' || title == null)
                return 12;
            if ("mr" == title.toLowerCase())
                return 0;
            else if ("mrs" == title.toLowerCase())
                return 1;
            else if ("ms" == title.toLowerCase())
                return 2;
            else if ("miss" == title.toLowerCase())
                return 3;
            else if ("master" == title.toLowerCase())
                return 4;
            else if ("dr" == title.toLowerCase())
                return 5;
            else if ("lord" == title.toLowerCase())
                return 6;
            else if ("lady" == title.toLowerCase())
                return 7;
            else if ("sir" == title.toLowerCase())
                return 8;
            else if ("col" == title.toLowerCase())
                return 9;
            else if ("prof" == title.toLowerCase())
                return 10;
            else if ("rev" == title.toLowerCase())
                return 11;
            else
                return 12;
        }

        // update reservation with booker
        function UpdateReservationWithBooker(contactId, reservationEntityId) {
            BookerForDPA = contactId;
            var entity = {};
            entity["whb_Contact@odata.bind"] = "/contacts(" + contactId + ")";
            if (MSCRMCallerID == "")
                GetConfiguratoinValues();
            $.ajax({
                type: "PATCH",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_reservations(" + reservationEntityId + ")",
                data: JSON.stringify(entity),
                beforeSend: function (XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                },
                async: true,
                success: function (data, textStatus, xhr) {
                    //Success - No Return Data - Do Something
                },
                error: function (xhr, textStatus, errorThrown) {
                    $('#loading').hide();
                    ErrorHandling("DPA Search", "DPA Search", "UpdateReservationWithBooker", xhr);
                }
            });
        }


        // associate contact with reservation
        function AssociateReservationWithContact(reservationId, contactId) {
            var association = {
                "@odata.id": Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_reservations(" + reservationId + ")"
            };
            if (MSCRMCallerID == "")
                GetConfiguratoinValues();
            $.ajax({
                type: "POST",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: Xrm.Page.context.getClientUrl() + "/api/data/v8.2/contacts(" + contactId + ")/whb_contact_whb_reservation/$ref",
                data: JSON.stringify(association),
                beforeSend: function (XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                },
                async: false,
                success: function (data, textStatus, xhr) {
                    //Success - No Return Data - Do Something
                },
                error: function (xhr, textStatus, errorThrown) {
                    ErrorHandling("DPA Search", "DPA Search", "AssociateReservationWithContact", xhr);
                }
            });
        }

        // Check contact is already present or not
        function CheckContactExists(guestHistoryNumber, reservationNumber, roomId, firstName) {
            var contactId = "";
            var urlCondition = "";
			if(firstName !=null)
			{
				if(firstName.indexOf("'"))
				{
					firstName=firstName.replace("'","''");
				}
			}
            if (guestHistoryNumber != "")
                urlCondition = Xrm.Page.context.getClientUrl() + "/api/data/v8.2/contacts?$select=contactid&$filter=whb_guesthistorynumber eq '" + guestHistoryNumber + "'";
            else if (reservationNumber != "" && roomId != "")
                urlCondition = Xrm.Page.context.getClientUrl() + "/api/data/v8.2/contacts?$select=whb_reservationnumber,whb_roomid&$filter=whb_reservationnumber eq '" + reservationNumber + "' and  whb_roomid eq '" + roomId + "' and firstname eq '" + firstName + "'";
            else if (reservationNumber != "" && firstName != "")
                urlCondition = Xrm.Page.context.getClientUrl() + "/api/data/v8.2/contacts?$select=whb_reservationnumber,whb_roomid&$filter=whb_reservationnumber eq '" + reservationNumber + "' and firstname eq '" + firstName + "'";

            if (urlCondition == "")
                return contactId;
            if (MSCRMCallerID == "")
                GetConfiguratoinValues();

            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: urlCondition,
                beforeSend: function (XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                    XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                },
                async: false,
                success: function (data, textStatus, xhr) {
                    var results = data;
                    for (var i = 0; i < results.value.length; i++) {
                        contactId = results.value[i]["contactid"];
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    $('#loading').hide();
                    ErrorHandling("DPA Search", "DPA Search", "CheckContactExists", xhr);
                }
            });

            return contactId;
        }

        // Get account information
        function GetCompanyInformation(comapnyCode, companyName) {
            var companyId = "";
            if (MSCRMCallerID == "")
                GetConfiguratoinValues();
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: Xrm.Page.context.getClientUrl() + "/api/data/v8.2/accounts?$select=accountid,accountnumber,name&$filter=accountnumber eq '" + comapnyCode + "'",
                beforeSend: function (XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                    XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                },
                async: false,
                success: function (data, textStatus, xhr) {
                    var results = data;
                    var accountId = '';
                    for (var i = 0; i < results.value.length; i++) {
                        companyId = results.value[i]["accountid"];
                    }
                    if (companyId == "") {
                        companyId = CreateCompanyInformation(comapnyCode, companyName);
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    $('#loading').hide();
                    ErrorHandling("DPA Search", "DPA Search", "GetCompanyInformation", xhr);
                }
            });

            return companyId;
        }

        // create new account
        function CreateCompanyInformation(accountnumber, accountname) {

            var companyId = "";
            var acNumber = "";
            var acName = "";

            if (accountnumber != '' && accountnumber != null && accountnumber != undefined)
                acNumber = accountnumber;

            if (accountname != '' && accountname != null && accountname != undefined)
                acName = accountname;

            if (acNumber == "" && acName == "") {
                companyId = '';
                return;
            }

            var entity = {};
            entity.accountnumber = accountnumber;
            if (accountname == '' || accountname == "" || accountname == undefined)
                entity.name = accountnumber;
            else
                entity.name = accountname;

            if (MSCRMCallerID == "")
                GetConfiguratoinValues();

            $.ajax({
                type: "POST",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: Xrm.Page.context.getClientUrl() + "/api/data/v8.2/accounts",
                data: JSON.stringify(entity),
                beforeSend: function (XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                },
                async: false,
                success: function (data, textStatus, xhr) {
                    var uri = xhr.getResponseHeader("OData-EntityId");
                    var regExp = /\(([^)]+)\)/;
                    var matches = regExp.exec(uri);
                    companyId = matches[1];
                },
                error: function (xhr, textStatus, errorThrown) {
                    $('#loading').hide();
                    ErrorHandling("DPA Search", "DPA Search", "CreateCompanyInformation", xhr);
                }
            });

            return companyId;
        }

        // get feedback details
        function GetFeedBackDetails(guestNumber, HistoryNumber) {
            try {
                var requestData = '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:cas="http://caseman.oracle.com"><soapenv:Header><Login><username>' + APIUserName + '</username><password>' + APIPassword + '</password></Login></soapenv:Header><soapenv:Body>';
                requestData += '<cas:feedbackRecordQuery><cas:request>';
                requestData += '<cas:guestHistoryNumber>' + guestNumber + '</cas:guestHistoryNumber>';
                requestData += '<cas:feedbackNumber>' + HistoryNumber + '</cas:feedbackNumber>';
                requestData += '</cas:request></cas:feedbackRecordQuery>';
                requestData += '</soapenv:Body></soapenv:Envelope>';
                var feedbackResponse = CallRequest(WSDLService, feedBackSearch, requestData);
                var feedBackData = GetFeedBackDetailsResponse(feedbackResponse);
                return feedBackData;
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "GetFeedBackDetails", err);
            }
        }

        function GetFeedBackDetailsResponse(response) {
            try {
                var data = "";
                var xmlDoc = response;
                $(xmlDoc).find('feedback').each(function () {
                    $(this).find('incidentLines').each(function () {
                        data = data + $(this).find('incidentLinesItem').text() + "\r\n";
                    });
                    $(this).find('resolutionLines').each(function () {
                        data = data + $(this).find('resolutionLinesItem').text() + "\r\n";
                    });
                    $(this).find('causeLines').each(function () {
                        data = data + $(this).find('causeLinesItem').text() + "\r\n";
                    });
                });
            }
            catch (err) {
                $('#loading').hide();
                ErrorHandling("DPA Search", "DPA Search", "GetFeedBackDetailsResponse", err);
            }
            return data;
        }

        //create or update reservation
        function CreateReservationInCRM(entity, reservationEntityId) {
            var createdReservationId = "";

            var type = '';
            var URL = '';
            if (reservationEntityId != "") {
                type = 'PATCH';
                URL = Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_reservations(" + reservationEntityId + ")";
            }
            else {

                type = 'POST';
                URL = Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_reservations";
            }
            if (MSCRMCallerID == "")
                GetConfiguratoinValues();
            $.ajax({
                type: type,
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: URL,
                data: JSON.stringify(entity),
                beforeSend: function (XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                },
                async: false,
                success: function (data, textStatus, xhr) {
                    if (reservationEntityId == "") {
                        var uri = xhr.getResponseHeader("OData-EntityId");
                        var regExp = /\(([^)]+)\)/;
                        var matches = regExp.exec(uri);
                        var newEntityId = matches[1];
                        createdReservationId = newEntityId;
                    } else {
                        createdReservationId = reservationEntityId;
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    $('#loading').hide();
                    ErrorHandling("DPA Search", "DPA Search", "CreateReservationInCRM", xhr);
                }
            });

            return createdReservationId;
        }

        // Calculate number of days in between two dates
        function showDays(firstDate, secondDate) {
            var startDay = new Date(firstDate);
            var endDay = new Date(secondDate);
            var millisecondsPerDay = 1000 * 60 * 60 * 24;

            var millisBetween = startDay.getTime() - endDay.getTime();
            var days = millisBetween / millisecondsPerDay;

            // Round down.
            return Math.floor(days);

        }

        // Check reservation exists or not in crm
        function CheckReservationExists(reservatinNumber) {

            if (MSCRMCallerID == "")
                GetConfiguratoinValues();

            var reservatinEntityId = "";
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_reservations?$select=whb_reservationid&$filter=whb_name eq '" + reservatinNumber.trim() + "'",
                beforeSend: function (XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                    XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                },
                async: false,
                success: function (data, textStatus, xhr) {
                    var results = data;
                    for (var i = 0; i < results.value.length; i++) {
                        reservatinEntityId = results.value[i]["whb_reservationid"];
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    $('#loading').hide();
                    ErrorHandling("DPA Search", "DPA Search", "CheckReservationExists", xhr);
                }
            });

            return reservatinEntityId;
        }

        // Get Property Name from Property code
        function GetPropertyId(PropertyCode) {
            if (MSCRMCallerID == "")
                GetConfiguratoinValues();
            var propertyId = "";
            try {
                $.ajax({
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    datatype: "json",
                    url: Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_properties?$select=whb_propertyid,whb_name&$filter=whb_propertycode eq '" + PropertyCode + "'",
                    beforeSend: function (XMLHttpRequest) {
                        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                        XMLHttpRequest.setRequestHeader("Accept", "application/json");
                        XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                    },
                    async: false,
                    success: function (data, textStatus, xhr) {
                        var results = data;
                        for (var i = 0; i < results.value.length; i++) {
                            propertyId = results.value[i]["whb_propertyid"];
                            // PropertyName = results.value[i]["whb_name"];
                        }
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        $('#loading').hide();
                        ErrorHandling("DPA Search", "DPA Search", "GetPropertyId", xhr);
                    }
                });
            } catch (e) {
                ErrorHandling("DPA Search", "DPA Search", "GetPropertyId", e);
            }
            return propertyId;
        }

        // Get Property Id from Property Name
        function GetPropertyIdFromPropertyName(PropertyName) {
            if (MSCRMCallerID == "")
                GetConfiguratoinValues();
            var propertyId = "";
            try {
                $.ajax({
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    datatype: "json",
                    url: Xrm.Page.context.getClientUrl() + "/api/data/v8.2/whb_properties?$select=whb_propertyid,whb_name&$filter=whb_name eq '" + PropertyName + "'",
                    beforeSend: function (XMLHttpRequest) {
                        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                        XMLHttpRequest.setRequestHeader("Accept", "application/json");
                        XMLHttpRequest.setRequestHeader("MSCRMCallerID", MSCRMCallerID);
                    },
                    async: false,
                    success: function (data, textStatus, xhr) {
                        var results = data;
                        for (var i = 0; i < results.value.length; i++) {
                            propertyId = results.value[i]["whb_propertyid"];
                            // PropertyName = results.value[i]["whb_name"];
                        }
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        $('#loading').hide();
                        ErrorHandling("DPA Search", "DPA Search", "GetPropertyId", xhr);
                    }
                });
            } catch (e) {
                ErrorHandling("DPA Search", "DPA Search", "GetPropertyId", e);
            }
            return propertyId;
        }
    </script>

    <meta>
    <meta charset="utf-8">
    <meta>
    <meta>
</head>
<body style="word-wrap: break-word;">
    <div class="contentdiv">
        <h1 class="formHeader">Whitbread Customer Search</h1>
        <div class="emptydiv">
        </div>
        <div class="searchdiv">
            <table class="searchtable">
                <tbody>
                    <tr>
                        <td class="ms-crm-InlineEditLabelText">Reservation Number</td>
                        <td>
                            <input tabindex="1" id="txtresvId" type="text">
                        </td>
                        <td class="ms-crm-InlineEditLabelText">Email Address</td>
                        <td>
                            <input tabindex="6" id="txtemail" type="text">
                        </td>
                    </tr>
                    <tr>
                        <td class="ms-crm-InlineEditLabelText">Third Party Booking Ref</td>
                        <td>
                            <input tabindex="2" id="txtBookref" type="text">
                        </td>
                        <td class="ms-crm-InlineEditLabelText">Postal Code</td>
                        <td>
                            <input tabindex="7" id="txtpostal" type="text">
                        </td>
                    </tr>

                    <tr>
                        <td class="ms-crm-InlineEditLabelText">Hotel Name</td>
                        <td>
                            <input tabindex="3" id="txthousename" type="text">
                        </td>
                        <td class="ms-crm-InlineEditLabelText">Telephone</td>
                        <td>
                            <input tabindex="8" id="txtphone" type="text" maxlength="20">
                        </td>

                    </tr>

                    <tr>
                        <td class="ms-crm-InlineEditLabelText">Date of Arrival</td>
                        <td>
                            <input tabindex="4" id="txtDateOfArrival" required="" type="text" maxlength="10" placeholder="DD/MM/YYYY">
                        </td>

                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td class="ms-crm-InlineEditLabelText">Days Either Side</td>
                        <td>
                            <input tabindex="5" id="txtDaysonEitherSide" type="text">
                        </td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td align="center" class="ms-crm-InlineEditLabelText">Surname</td>
                        <td>
                            <input tabindex="9" id="txtsurname" type="text">
                        </td>
                    </tr>
                    <tr>
                        <td style="height: 10px;" colspan="4"> </td>
                    </tr>
                    <tr>
                        <td colspan="4">
                            <input class="btnbutton" id="search" onclick="SearchReservationAndContact()" type="button" value="Search">
                            &nbsp;
                            <input class="btnbutton" id="reset" onclick="resetValues()" type="button" value="Reset">
                            <!--&nbsp;-->
                            <!--<input class="btnbutton" id="cancel" type="button" value="Cancel">-->
                            &nbsp;
                            <input disabled="true" class="btnbutton" id="CreateCase" onclick="CheckDPA()" type="button" value="Check DPA">
                        </td>
                    </tr>
                </tbody>
            </table>
            <br>
            <input id="txtSearchedFields" style="display: none;" type="text">
        </div>
        <div id="loading" style="width: 100%; text-align: center; display: none;"></div>
        <br>
        <div class="tableDiv"></div>
        <div style="width: 100%; height: 20px;"></div>
        <div id="resultdiv" style="padding-right: 10px; padding-left: 10px;"></div>
        <div id="pageNavPosition" style="width: 90%; padding-top: 20px; padding-left: 10px;"></div>
    </div>


</body>
</html>